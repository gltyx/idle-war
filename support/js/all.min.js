
function viewAchievements()
{tutorial_message('achievements-welcome');$('#main-content').load('./achievements.html',function(){var current_progress=0;$.each(achievements,function(upgrade_index,achievement){current_progress=getValue(player.milestones[achievement.tracker],0);var html='';if(current_progress>=achievement.requirement)
{html='<div class="achievement"><span class="name">'+achievement.name+'</span>';html+='<span class="description">'+achievement.description+'<span class="reward">Points rewarded: '+achievement.reward_points+'</span></span>';html+='</div>';$('.achievements-list #achievements-unlocked').append(html);}
else
{html='<div class="achievement"><span class="name">'+achievement.name+'</span>';html+='<span class="description">'+achievement.description+'<span class="reward">Reward points: '+achievement.reward_points+'</span></span>';html+='<div class="info"><span class="current-progress" style="width: '+(current_progress/achievement.requirement*100)+'%"></span>';html+='<span class="info-text">'+current_progress+'/'+achievement.requirement+' '+achievement.unit+'</span>';html+='</div>';html+='</div>';$('.achievements-list #achievements-in-progress').append(html);}});});}
function checkAchievementCompleted()
{var current_progress=0;$.each(achievements,function(upgrade_index,achievement){if(!player.achievements[achievement.id])
{current_progress=getValue(player.milestones[achievement.tracker],0);if(current_progress>=achievement.requirement)
{player.milestones.achievements_unlocked=(player.milestones.achievements_unlocked||0)+1;player.achievements[achievement.id]=true;player.earned_points+=achievement.reward_points;player.available_points+=achievement.reward_points;player.milestones.points_earned=(player.milestones.points_earned||0)+achievement.reward_points;info_message_box('Achievement unlocked','You have unlocked the <span class="purple">'+achievement.name+'</span> achievement and earned <span class="purple">'+achievement.reward_points+'</span> point(s)');if($('.journal-container #journal-content').length>0)
$('.journal-container #journal-content').append('<p class="achievement-text">You have unlocked the '+achievement.name+' achievement and earned '+achievement.reward_points+' point(s)</p>');}}});}
function show_achievements_in_progress()
{$('.achievements-container .achievements-list #achievements-in-progress').show(0);$('.achievements-container .achievements-list #achievements-unlocked').hide(0);$('.achievements-container .buttons a').removeClass('button-active');$('.achievements-container .buttons a.achievements-in-progress').addClass('button-active');}
function show_achievements_unlocked()
{$('.achievements-container .achievements-list #achievements-in-progress').hide(0);$('.achievements-container .achievements-list #achievements-unlocked').show(0);$('.achievements-container .buttons a').removeClass('button-active');$('.achievements-container .buttons a.achievements-unlocked').addClass('button-active');}
var stories={story_1:{name:'Volume I - The arrival',description:'Something is happening on our solar system. All of a sudden, a lot of ships just started closing on our planets. What could they want?',missions:{0:{name:'Chapter I - Awakening',description:'They just started opening fire on us. We need to try to fight them off.',type:'standard',hero_slots:1,slot_positions:['middle'],required_level:10,unlocks:['hero-2'],upgrade_points:2,bonus_xp:1000,enemies:['group-1','group-2','group-3'],kills_required:[5,5,5,5,5,10,10,10,10,10],bosses:5,modifiers:{hero_dps:1,hero_health:1,enemy_dps:1,enemy_health:1,xp_gain:1,base_max_enemies:3,max_enemies_increase_levels:10},backgrounds:[{from_level:1,group:'mission-1-planet'},{from_level:9,group:'mission-1-moon'}],messages:{1:{text:"The ships approaching are trying to breach through our defenses. Stop them from coming through!"},5:{text:"Something doesn't feel right. It's like something bigger is comming..."},6:{text:"That was a difficult boss. Let's keep pushing those ships away!"},9:{text:"Is that a transmission? ....Br...r... help ... now..."},11:{text:"You found me! I pilot the Bruiser, a Tank ship. I'll join you and together we can find out what is going on here!"},12:{text:"Mission has ended. You can carry on destroying enemy ships for XP."}},music:'mission-1-1'},1:{name:'Chapter II - Defend the base',description:'While we were busy fighting the first wave of enemies, some managed to evade us and are now attacking one of our bases.',type:'standard',hero_slots:2,slot_positions:['l25','r25'],required_level:20,unlocks:['hero-3'],upgrade_points:3,bonus_xp:5000,enemies:['group-1','group-2','group-3','group-1','group-2','group-3','group-1','group-2','group-3','group-4','group-4','group-4','group-4','group-4','group-4','group-4','group-4','group-4','group-4','group-4'],kills_required:[10],bosses:5,modifiers:{hero_dps:1,hero_health:1,enemy_dps:1,enemy_health:1,xp_gain:1,base_max_enemies:3,max_enemies_increase_levels:10},backgrounds:[{from_level:1,group:'mission-2-base'},{from_level:6,group:'mission-2-base-parallax'},{from_level:11,group:'mission-2-shipyard'},{from_level:15,group:'mission-2-base-parallax'},{from_level:18,group:'mission-2-base-healer'},{from_level:19,group:'mission-2-base-parallax'}],messages:{1:{text:"Everyone be ready! We can't lose this base to them!"},6:{text:"Good job. They are moving away! Wait, nooooo. They are going after the shipyard. Follow them!"},11:{text:"Defend the shipyard. They can't destroy it."},15:{text:"They are still coming. And seems like they brought some new    friends   ."},18:{text:"There, it looks like that ship is in trouble. Let's help it!"},19:{text:"Hi. I'm the pilot of the Healer, a Support ship. This was getting difficult for me. Thank you for the help. The least I can do is join your group."},21:{text:"Mission has ended. You can carry on destroying enemy ships for XP."}},music:'mission-1-2'},2:{name:'Chapter III - City defense',description:'They have double back and are attacking one of our cities. They are defenceless and we must help!',type:'standard',hero_slots:3,slot_positions:['l25','middle','r25'],required_level:30,unlocks:[],upgrade_points:5,bonus_xp:10000,enemies:['group-3','group-3','group-2','group-2','group-3','group-2','group-3','group-2','group-1'],kills_required:[10],bosses:5,modifiers:{hero_dps:1,hero_health:1,enemy_dps:1,enemy_health:1,xp_gain:1,base_max_enemies:3,max_enemies_increase_levels:5},backgrounds:[{from_level:1,group:'mission-3-countryside'},{from_level:11,group:'mission-3-cityscape'}],messages:{1:{text:"Alright everyone, let's push through and get to the city as soon as possible."},11:{text:"We are here. It doesn't look like there has been a lot of destruction. This is a good thing."},21:{text:"We are almost there, just a final push and the city will be safe from the invaders."},31:{text:"Mission has ended. You can carry on destroying enemy ships for XP."}},music:'mission-1-3'},3:{name:'Chapter IV - New developments',description:'As the city is successfully defended from the invading forces, new information is reaching the headquarters.',type:'standard',hero_slots:3,slot_positions:['l25','middle','r25'],required_level:30,unlocks:[],upgrade_points:8,bonus_xp:20000,enemies:['group-3','group-3','group-2','group-2','group-3','group-2','group-3','group-2','group-3','group-4','group-5','group-4','group-5','group-4','group-5'],kills_required:[15],bosses:10,modifiers:{hero_dps:1,hero_health:1,enemy_dps:1.2,enemy_health:1.2,xp_gain:1,base_max_enemies:4,max_enemies_increase_levels:5},backgrounds:[{from_level:1,group:'mission-3-cityscape'},{from_level:11,group:'mission-4-countryside'},{from_level:21,group:'mission-4-desert'},{from_level:31,group:'mission-4-headquarters'},{from_level:41,group:'mission-2-shipyard'}],messages:{1:{text:"We have to make our way to the headquarters. It seems they have discovered new information!"},11:{text:"We should make a detour, this is taking too long."},12:{text:"Oh, what a great detour you found for us. It's full of enemies! This is going to take forever!"},21:{text:"We are getting closer to the headquarters, we can almost see it in the horizon."},26:{text:"We might have found where they come from. Make your way to the shipyard, rearm and go investigate on these coordinates."},31:{text:"Here's the shipyard. Seems we attracted some more enemies here. Let's fight them off and prepare to jump to space."}},music:'mission-1-4'},4:{name:'Chapter V - Intelligence gathering',description:"We must find out who they are and what they want. We are taking heavy losses and this can't continue.",type:'standard',hero_slots:3,slot_positions:['l25','middle','r25'],required_level:30,unlocks:[],upgrade_points:10,bonus_xp:30000,enemies:['group-3','group-3','group-2','group-2','group-3','group-2','group-3','group-2','group-3','group-4','group-5','group-4','group-5','group-4','group-5'],kills_required:[15],bosses:10,modifiers:{hero_dps:1,hero_health:1,enemy_dps:1.5,enemy_health:1.5,xp_gain:1,base_max_enemies:4,max_enemies_increase_levels:5},backgrounds:[{from_level:1,group:'mission-5-dark-space'},{from_level:31,group:'mission-5-nebula-1'},{from_level:51,group:'mission-5-nebula-2'},{from_level:81,group:'mission-5-enemy-planet'}],messages:{1:{text:"Lets see what is out there."},6:{text:"Are we ever going to find them?"},11:{text:"Where are they coming from? All we see is the blackness of space."},16:{text:"This doesn't look right. There's something odd approaching, I can feel it."},21:{text:"That looks alien. We should investigate what is in there."},26:{text:"They have some really hard defences in place. Wonder what we will find down there?"},31:{text:"Mission has ended. You can carry on destroying enemy ships for XP."}},music:'mission-1-5'},10:{name:'Freeplay',description:'Neverending mission to farm equipment and XP. First time you kill a boss you will get a guaranteed equipment piece. Complete stage 50 to unlock the next difficulty and the ability to skip stages up to 90% of your highest stage reached on each difficulty setting (rounded down to the nearest 10 plus 1).',type:'freeplay',hero_slots:3,slot_positions:['l25','middle','r25'],required_level:50,unlocks:[],upgrade_points:0,bonus_xp:0,enemies:['group-8'],kills_required:[15],bosses:10,modifiers:{hero_dps:1,hero_health:1,enemy_dps:1,enemy_health:1,xp_gain:1,base_max_enemies:3,max_enemies_increase_levels:10},backgrounds:[{from_level:1,group:'mission-1-planet'},{from_level:11,group:'mission-2-base'},{from_level:21,group:'mission-2-base-parallax'},{from_level:31,group:'mission-2-shipyard'},{from_level:41,group:'mission-5-dark-space'},{from_level:51,group:'mission-5-enemy-planet'}],messages:{1:{text:"How far can you get? Test yourself, push yourself and keep on earning XP!"}},music:'mission-1-freeplay'},}}};ship_stats={'hero-1':{name:'Stargazer',description:"A fighter by nature, it destroys all the enemies on its path",base_attack:1.5,base_bullets:2,base_health:45,base_attack_speed:2000,base_delay_bullet:100,base_efficiency_cost:200,max_rounds:3,attack:'closest',enemy_focus:3,image:'hero-1.png',projectile:'hero-1-projectile.png',projectile_hit:'projectile-hit-1.png',projectile_rotate:false,projectile_audio:'stargazer-fire',tint:null,equipment:{equipment_1:{type:'self-damage-reduction',value:0.2,unit:'hp',max_level:500},equipment_2:{type:'self-damage',value:0.2,unit:'%',max_level:0},equipment_3:{type:'self-attack-speed',value:0.05,unit:'%',max_level:0},equipment_4:{type:'global-xp-boost',value:0.1,unit:'%',max_level:0},equipment_5:{type:'self-damage-plus-self-hp-minus',values:[0.5,0.05],unit:'%',max_level:500}},earnable_equipment:['equipment_1','equipment_2','equipment_3','equipment_4','equipment_5'],upgrade_slots:[0,10,30],bonuses:[{method:'constant',type:'player-damage',value:5,efficiency_bonus:0.1}]},'hero-2':{name:'Bruiser',description:"Improves the HP of your group, as well as focuses enemy fire on itself",base_attack:1,base_bullets:1,base_health:150,base_attack_speed:3000,base_delay_bullet:0,base_efficiency_cost:150,max_rounds:5,attack:'stronger',enemy_focus:5,image:'hero-2.png',projectile:'hero-2-projectile.png',projectile_hit:'projectile-hit-1.png',projectile_rotate:false,projectile_audio:'bruiser-fire',tint:null,equipment:{equipment_1:{type:'self-damage-reduction',value:0.2,unit:'hp',max_level:500},equipment_2:{type:'global-damage-reduction',value:0.1,unit:'hp',max_level:500},equipment_3:{type:'self-hp',value:0.2,unit:'%',max_level:0},equipment_4:{type:'global-hp',value:0.1,unit:'%',max_level:0},equipment_5:{type:'enemy-hp-plus-global-damage-reduction-minus',values:[0.05,0.1],unit:'hp',max_level:500}},earnable_equipment:['equipment_1','equipment_2','equipment_3','equipment_4','equipment_5'],upgrade_slots:[0,15,40],bonuses:[{method:'constant',type:'hp-bonus',value:5,efficiency_bonus:0.2}]},'hero-3':{name:'Relief',description:"Keeps your group's HP high, providing a repairing service on the fly",base_attack:0.5,base_bullets:1,base_health:30,base_attack_speed:5000,base_delay_bullet:0,base_efficiency_cost:200,max_rounds:4,attack:'closest',enemy_focus:1,image:'hero-3.png',projectile:'hero-3-projectile.png',projectile_hit:'projectile-hit-1.png',projectile_rotate:false,projectile_audio:'relief-fire',tint:null,equipment:{equipment_1:{type:'global-damage-reduction',value:0.05,unit:'hp',max_level:500},equipment_2:{type:'global-hp',value:0.2,unit:'%',max_level:0},equipment_3:{type:'global-attack-speed',value:0.05,unit:'%',max_level:0},equipment_4:{type:'global-xp-boost',value:0.15,unit:'%',max_level:0},equipment_5:{type:'global-hp-plus-global-attack-speed-minus',values:[0.4,0.1],unit:'%',max_level:1000}},earnable_equipment:['equipment_1','equipment_2','equipment_3','equipment_4','equipment_5'],upgrade_slots:[0,20,50],bonuses:[{method:'trigger',type:'healing',value:5,interval:5,efficiency_bonus:0.1}]}};var bonuses={};var global_equipment_bonuses={xp_boost:0,damage_reduction:0,hp_boost:0,damage_boost:0,attack_speed:0,enemy_hp_reduction:0};var upgrades={'smart-projectiles':{name:'Smart projectiles',type:'global-damage',modifier:0.1,max_level:5,cost_modifier:1,requirements:[]},'scholar':{name:'Scholar',type:'efficiency-cost-reduction',modifier:0.02,max_level:5,cost_modifier:1,requirements:[]},'know-your-enemy':{name:'Know your enemy',type:'global-xp-boost',modifier:0.05,max_level:10,cost_modifier:1,requirements:[]},'aggressive-stance':{name:'Aggressive stance',type:'enemy-hp-reduction',modifier:0.02,max_level:5,cost_modifier:1,requirements:[]},'metal-composites':{name:'Metal composites',type:'global-hp',modifier:0.1,max_level:10,cost_modifier:1,requirements:['scholar']},'lucky-charm':{name:'Lucky charm',type:'equipment-drop-rate',modifier:0.01,max_level:5,cost_modifier:2,requirements:['scholar']},'practice-makes-it-perfect':{name:'Practice makes it perfect',type:'bonus-trigger-interval',modifier:0.05,max_level:5,cost_modifier:3,requirements:['aggressive-stance']},'auto-fire':{name:'Auto fire',type:'bonus-auto-fire',modifier:0.2,max_level:5,cost_modifier:1,requirements:['smart-projectiles']},'auto-loader':{name:'Auto loader',type:'bonus-rounds',modifier:1,max_level:3,cost_modifier:2,requirements:['auto-fire']}};var bonus_icons={'self-damage-reduction':{image:'self-damage-reduction.png'},'global-damage-reduction':{image:'global-damage-reduction.png'},'self-damage':{image:'self-damage.png'},'global-damage':{image:'global-damage.png'},'self-attack-speed':{image:'self-attack-speed.png'},'global-attack-speed':{image:'global-attack-speed.png'},'self-hp':{image:'self-hp.png'},'global-hp':{image:'global-hp.png'},'global-xp-boost':{image:'global-xp-boost.png'},'efficiency-cost-reduction':{image:'efficiency-cost-reduction.png'},'enemy-hp-reduction':{image:'enemy-hp-reduction.png'},'equipment-drop-rate':{image:'equipment-drop-rate.png'},'global-hp-plus-global-attack-speed-minus':{image:'global-hp-plus-global-attack-speed-minus.png'},'enemy-hp-plus-global-damage-reduction-minus':{image:'enemy-hp-plus-global-damage-reduction-minus.png'},'self-damage-plus-self-hp-minus':{image:'self-damage-plus-self-hp-minus.png'},'bonus-trigger-interval':{image:'bonus-trigger-interval.png'},'bonus-auto-fire':{image:'bonus-auto-fire.png'},'bonus-rounds':{image:'bonus-rounds.png'}};var qualities=[{name:'Common',short_name:'E',color:'#fff',multiplier:1,probability:10,level_required:0},{name:'Uncommon',short_name:'D',color:'#4B65EA',multiplier:1.2,probability:5,level_required:10,cost:150000},{name:'Rare',short_name:'C',color:'#F4FC5D',multiplier:1.5,probability:2,level_required:30,cost:500000},{name:'Epic',short_name:'B',color:'#7157B2',multiplier:2,probability:1,level_required:75,cost:5000000},{name:'Legendary',short_name:'A',color:'#C68D31',multiplier:3,probability:0.5,level_required:150,cost:10000000}];var BASE_DROP_RATE_PROBABILITY=10;var enemies_stats={'enemy-1':{attack:0.3,bullets:1,health:2,attack_speed:1500,delay_bullet:1000,target:'random',image:'enemy-1.png',image_medium:'enemy-1-medium.png',image_large:'enemy-1-large.png',projectile:'projectile-1.png',projectile_hit:'projectile-hit-1.png',tint:null},'enemy-2':{attack:0.2,bullets:1,health:1.5,attack_speed:1000,delay_bullet:1000,target:'priority',image:'enemy-2.png',image_medium:'enemy-2-medium.png',image_large:'enemy-2-large.png',projectile:'projectile-1.png',projectile_hit:'projectile-hit-1.png',tint:'0x00ffff'},'enemy-3':{attack:0.2,bullets:3,health:3,attack_speed:3000,delay_bullet:200,target:'priority',image:'enemy-3.png',image_medium:'enemy-3-medium.png',image_large:'enemy-3-large.png',projectile:'projectile-1.png',projectile_hit:'projectile-hit-1.png',tint:'0xff00ff'},'enemy-4':{attack:0.3,bullets:2,health:4,attack_speed:5000,delay_bullet:200,target:'priority',image:'enemy-4.png',image_medium:'enemy-4-medium.png',image_large:'enemy-4-large.png',projectile:'projectile-1.png',projectile_hit:'projectile-hit-1.png',tint:'0xff33ff'},'enemy-5':{attack:0.1,bullets:5,health:2.5,attack_speed:4000,delay_bullet:200,target:'random',image:'enemy-5.png',image_medium:'enemy-5-medium.png',image_large:'enemy-5-large.png',projectile:'projectile-1.png',projectile_hit:'projectile-hit-1.png',tint:'0xfff331'},'enemy-6':{attack:0.5,bullets:1,health:3,attack_speed:3500,delay_bullet:200,target:'random',image:'enemy-6.png',image_medium:'enemy-6-medium.png',image_large:'enemy-6-large.png',projectile:'projectile-1.png',projectile_hit:'projectile-hit-1.png',tint:'0xaa61a0'}};var enemy_groups={'group-1':['enemy-1','enemy-2'],'group-2':['enemy-1','enemy-3'],'group-3':['enemy-1','enemy-2','enemy-3'],'group-4':['enemy-1','enemy-4'],'group-5':['enemy-4','enemy-5'],'group-6':['enemy-2','enemy-4','enemy-5'],'group-7':['enemy-3','enemy-5','enemy-6'],'group-8':['enemy-1','enemy-2','enemy-3','enemy-4','enemy-5','enemy-6'],};var enemy_modifiers={attack_increase_per_level:0.15,attack_increase_x_level:0.70,attack_level_breakpoint:15,hp_increase_per_level:0.01,hp_increase_x_level:1,hp_level_breakpoint:20};var game_backgrounds={'mission-1-planet':{images:[['story-1/mission-1-planet.jpg',0,768,1334],['story-1/mission-1-stars.png',0.2,768,1536]],mode:'scroll'},'mission-1-moon':{images:[['story-1/mission-1-moon.jpg',0,768,1334],['story-1/mission-1-stars.png',0.2,768,1536]],mode:'scroll'},'mission-2-base':{images:[['story-1/mission-2-base-static.jpg',0,768,1334]],mode:'static'},'mission-2-base-parallax':{images:[['story-1/mission-2-base-static.jpg',0.3,768,1334]],mode:'scroll'},'mission-2-shipyard':{images:[['story-1/mission-2-shipyard.jpg',0,768,1334]],mode:'static'},'mission-2-base-healer':{images:[['story-1/mission-2-healer.jpg',0,768,1334]],mode:'static'},'mission-3-countryside':{images:[['story-1/mission-3-countryside.jpg',0.3,768,1500]],mode:'scroll'},'mission-3-cityscape':{images:[['story-1/mission-3-cityscape.jpg',0,834,1433]],mode:'static'},'mission-4-countryside':{images:[['story-1/mission-4-countryside.jpg',0.3,768,1820]],mode:'scroll'},'mission-4-desert':{images:[['story-1/mission-4-desert.jpg',0.3,768,1970]],mode:'scroll'},'mission-4-headquarters':{images:[['story-1/mission-4-headquarters.jpg',0,768,1334]],mode:'static'},'mission-5-dark-space':{images:[['story-1/mission-5-dark-space.jpg',0,768,1334],['story-1/mission-5-stars.png',0.2,768,1536]],mode:'scroll'},'mission-5-nebula-1':{images:[['story-1/mission-5-nebula-1.jpg',0,768,1334],['story-1/mission-5-stars.png',0.2,768,1536]],mode:'scroll'},'mission-5-nebula-2':{images:[['story-1/mission-5-nebula-2.jpg',0,768,1334],['story-1/mission-5-stars.png',0.2,768,1536]],mode:'scroll'},'mission-5-enemy-planet':{images:[['story-1/mission-5-enemy-planet.jpg',0,768,1334]],mode:'static'},};achievements=[{id:'destroyer-1',name:'Destroyer I',description:'Kill 10000 enemies',requirement:10000,unit:'kills',reward_points:1,tracker:'total_kills'},{id:'destroyer-2',name:'Destroyer II',description:'Kill 50000 enemies',requirement:50000,unit:'kills',reward_points:2,tracker:'total_kills'},{id:'destroyer-3',name:'Destroyer III',description:'Kill 100000 enemies',requirement:100000,unit:'kills',reward_points:3,tracker:'total_kills'},{id:'boss-slayer-1',name:'Boss slayer I',description:'Kill 500 bosses',requirement:500,unit:'kills',reward_points:1,tracker:'total_boss_kills'},{id:'boss-slayer-2',name:'Boss slayer II',description:'Kill 2500 bosses',requirement:2500,unit:'kills',reward_points:2,tracker:'total_boss_kills'},{id:'boss-slayer-3',name:'Boss slayer III',description:'Kill 10000 bosses',requirement:10000,unit:'kills',reward_points:3,tracker:'total_boss_kills'},{id:'stargazer-focus-1',name:'Stargazer focus I',description:'Kill 5000 enemies',requirement:5000,unit:'kills',reward_points:1,tracker:'stargazer_kills'},{id:'stargazer-focus-2',name:'Stargazer focus II',description:'Kill 25000 enemies',requirement:25000,unit:'kills',reward_points:2,tracker:'stargazer_kills'},{id:'stargazer-focus-3',name:'Stargazer focus III',description:'Kill 50000 enemies',requirement:50000,unit:'kills',reward_points:3,tracker:'stargazer_kills'},{id:'bruiser-focus-1',name:'Bruiser focus I',description:'Kill 1000 enemies',requirement:1000,unit:'kills',reward_points:1,tracker:'bruiser_kills'},{id:'bruiser-focus-2',name:'Bruiser focus II',description:'Kill 5000 enemies',requirement:5000,unit:'kills',reward_points:2,tracker:'bruiser_kills'},{id:'bruiser-focus-3',name:'Bruiser focus III',description:'Kill 10000 enemies',requirement:10000,unit:'kills',reward_points:3,tracker:'bruiser_kills'},{id:'relief-focus-1',name:'Relief focus I',description:'Kill 1000 enemies',requirement:1000,unit:'kills',reward_points:1,tracker:'relief_kills'},{id:'relief-focus-2',name:'Relief focus II',description:'Kill 5000 enemies',requirement:5000,unit:'kills',reward_points:2,tracker:'relief_kills'},{id:'relief-focus-3',name:'Relief focus III',description:'Kill 10000 enemies',requirement:10000,unit:'kills',reward_points:3,tracker:'relief_kills'},{id:'that-tickles',name:'That tickles!',description:'Prevent 10000 damage',requirement:10000,unit:'dmg',reward_points:1,tracker:'total_damage_prevented'},{id:'was-that-meant-for-me',name:'Was that meant for me?',description:'Prevent 100000 damage',requirement:100000,unit:'dmg',reward_points:2,tracker:'total_damage_prevented'},{id:'its-full-of-projectiles',name:"It's full of projectiles",description:'Give 100000 damage',requirement:100000,unit:'dmg',reward_points:1,tracker:'total_damage_given'},{id:'have-you-had-enough',name:"Have you had enough?",description:'Give 1000000 damage',requirement:1000000,unit:'dmg',reward_points:2,tracker:'total_damage_given'},{id:'medic',name:"Medic!!!",description:'Heal 5000 hit points',requirement:5000,unit:'hp',reward_points:1,tracker:'total_hp_healed'},{id:'ill-need-some-assistance-please',name:"I   ll need some assistance please",description:'Heal 50000 hit points',requirement:50000,unit:'hp',reward_points:2,tracker:'total_hp_healed'},{id:'this-will-be-useful',name:"This will be useful",description:'Collect 10000 xp',requirement:10000,unit:'xp',reward_points:1,tracker:'xp_earned'},{id:'more-xp-please',name:"More xp please",description:'Collect 100000 xp',requirement:100000,unit:'xp',reward_points:1,tracker:'xp_earned'},{id:'this-is-really-useful',name:"This is really useful",description:'Collect 500000 xp',requirement:500000,unit:'xp',reward_points:2,tracker:'xp_earned'},{id:'on-a-mission',name:"On a mission",description:'Complete 5 missions',requirement:5,unit:'missions',reward_points:1,tracker:'missions_completed'},{id:'round-round-round-we-go',name:"Round, round, round we go",description:'Complete 20 missions',requirement:20,unit:'missions',reward_points:2,tracker:'missions_completed'},{id:'mission-focused',name:"Mission focused!",description:'Complete 100 missions',requirement:100,unit:'missions',reward_points:3,tracker:'missions_completed'},{id:'freeplay-helper',name:"Freeplay - Mission helper",description:'Complete 5 freeplay runs (stage 50+ required)',requirement:5,unit:'missions',reward_points:1,tracker:'freeplay_completed'},{id:'freeplay-farmer',name:"Freeplay - Mission farmer",description:'Complete 20 freeplay runs (stage 50+ required)',requirement:20,unit:'missions',reward_points:2,tracker:'freeplay_completed'},{id:'freeplay-entrepreneur',name:"Freeplay - Mission entrepreneur",description:'Complete 100 freeplay runs (stage 50+ required)',requirement:100,unit:'missions',reward_points:3,tracker:'freeplay_completed'},{id:'freeplay-learning-ropes',name:"Freeplay - Learning ropes",description:'Complete stage 50 in freeplay missions',requirement:50,unit:'levels',reward_points:1,tracker:'freeplay_highest_level'},{id:'freeplay-on-a-mission',name:"Freeplay - On a mission",description:'Complete stage 100 in freeplay missions',requirement:100,unit:'levels',reward_points:2,tracker:'freeplay_highest_level'},{id:'freeplay-grinder',name:"Freeplay - grinder",description:'Complete stage 250 in freeplay missions',requirement:250,unit:'levels',reward_points:3,tracker:'freeplay_highest_level'},{id:'freeplay-will-it-ever-end',name:"Freeplay - Will it even end?",description:'Complete stage 500 in freeplay missions',requirement:500,unit:'levels',reward_points:5,tracker:'freeplay_highest_level'}];var empty_player_structure={dps:0,level:1,enemies_created:0,enemies_alive:0,heroes_list:[],equipment:[],current_credits:0,earned_credits:0,available_credits:0,targets_destroyed:0,earned_points:0,available_points:0,upgrades:{},current_story:null,current_mission:null,current_heroes:[],mission_max_level:{},options:{sound:1,music:1,ratio:1,speed:1,notifications:0},tutorial_messages:{},milestones:{missions_completed:0,freeplay_completed:0,levels_completed:0,freeplay_highest_level:0,total_kills:0,total_boss_kills:0,total_damage_given:0,total_damage_received:0,stargazer_kills:0,stargazer_boss_kills:0,stargazer_damage_given:0,stargazer_damage_received:0,stargazer_hits_on_enemy:0,stargazer_hits_on_player_ship:0,bruiser_kills:0,bruiser_boss_kills:0,bruiser_damage_given:0,bruiser_damage_received:0,bruiser_hits_on_enemy:0,bruiser_hits_on_player_ship:0,relief_kills:0,relief_boss_kills:0,relief_damage_given:0,relief_damage_received:0,relief_hp_healed:0,relief_hits_on_enemy:0,relief_hits_on_player_ship:0,total_damage_prevented:0,total_hp_healed:0,hits_on_enemy:0,hits_on_player_ship:0,xp_earned:0,points_earned:0,achievements_unlocked:0,total_play_time:0},achievements:{}};var player=empty_player_structure;var tutorial_messages={'menu-welcome':{title:"Welcome to Idle War",message:"From time to time, messages like these will show up to guide you trough the game, or giving you information about something that happened, like a new piece of equipment found, or story progression.<br />Click anywhere on the message to dismiss the box."},'menu-ship':{title:"Your ships",message:"On this screen you can view your ships, change and level up the equipment, and level up your ship. Leveling up the ship increases the <span class='purple uc'>Attack</span>, <span class='purple uc'>Health</span> and any <span class='purple uc'>Bonus</span> the ship has."},'first-mission':{title:"Your first mission",message:"For your ship to fire, click on the <span class='purple uc'>FIRE</span> button. Earn upgrade points and unlock the <span class='purple uc'>Auto fire</span> from the <span class='purple uc'>Upgrades menu</span>. As you fight off different waves, they will get stronger, and now and then an harder enemy, the Boss, will show up."},'first-equipment':{title:"Your first equipment",message:"As you kill a Boss, there is a chance of getting a piece of equipment for your ship. The first time you kill a boss on a specific stage, the drop is guaranteed. Click on your ship to view and change the equipment. Can also be done from the main menu."},'achievements-welcome':{title:"Achievements",message:"Here you can track your progress in achieving certain milestones. When you achieve one of them, you will be rewarded points to be spent on upgrades."},'upgrades-welcome':{title:"Upgrades",message:"These are upgrades you can buy with points. Earn points by completing missions or unlocking achievements."},'gameplay-end-mission':{title:"Ending the mission",message:"You can end the mission any time by clicking on the 'Complete Mission' button on the top bar."}};class HealthBar
{constructor(scene,x,y)
{this.bar=new Phaser.GameObjects.Graphics(scene);this.x=x;this.y=y;this.value=100;this.p=48/100;this.draw();scene.add.existing(this.bar);}
updatePositionX(x)
{this.x=x;this.draw();}
updatePositionY(y)
{this.y=y;this.draw();}
updateAmount(amount)
{this.value=Math.max(0,amount);this.draw();return(this.value===0);}
draw()
{this.bar.clear();this.bar.fillStyle(0x000000);this.bar.fillRect(this.x,this.y,50,6);this.bar.fillStyle(0xffffff);this.bar.fillRect(this.x+1,this.y+1,48,4);if(this.value<30)
this.bar.fillStyle(0xA00000);else
this.bar.fillStyle(0x42CC33);var d=Math.floor(this.p*this.value);this.bar.fillRect(this.x+1,this.y+1,d,4);}
destroy()
{this.bar.destroy();}}
class Enemy extends Phaser.GameObjects.Image
{constructor(scene,isBoss,positionX)
{var selected_enemy_group=stories[player.current_story].missions[player.current_mission].enemies[player.level%stories[player.current_story].missions[player.current_mission].enemies.length];var params=enemies_stats[enemy_groups[selected_enemy_group][Math.floor(Math.random()*enemy_groups[selected_enemy_group].length)]];var difficulty_increase=player.current_difficulty==2?10:(player.current_difficulty==1?4:1);super(scene,0,0,'enemy-'+(isBoss?params.image_medium:params.image));this.setOrigin(0);this.setDepth(2);this.isBoss=isBoss;this.params=params;this.hp=this.params.health*((1+((player.level-1)*enemy_modifiers.hp_increase_per_level))+((Math.floor((player.level-1)/enemy_modifiers.hp_level_breakpoint)*enemy_modifiers.hp_increase_x_level)));this.hp=this.hp*(1+Math.floor((player.level-1)/100)*0.5);if(isBoss)
this.hp=this.hp*10;this.hp=this.hp*stories[player.current_story].missions[player.current_mission].modifiers.enemy_health;this.hp=Math.max(1,this.hp-(this.hp*bonuses['enemy-hp-reduction'])-global_equipment_bonuses.enemy_hp_reduction);this.hp=Math.ceil(this.hp*difficulty_increase);this.current_hp=this.hp;this.damage=this.params.attack*((1+((player.level-1)*enemy_modifiers.attack_increase_per_level))+((Math.floor((player.level-1)/enemy_modifiers.attack_level_breakpoint)*enemy_modifiers.attack_increase_x_level)));this.damage=this.damage*(1+Math.floor((player.level-1)/100)*0.5);if(isBoss)
this.damage=this.damage*5;this.damage=this.damage*difficulty_increase;this.damage=(this.damage*stories[player.current_story].missions[player.current_mission].modifiers.enemy_dps).toFixedNumber(2);debug('Creating enemy with '+this.hp+' HP and '+this.damage+' damage (difficulty increase: '+difficulty_increase+')',0);this.timer=scene.time.addEvent({delay:this.params.attack_speed/3/SPEED_FACTOR,callback:this.selectTarget,callbackScope:this});var self=this;this.canFire=false;var random=new Phaser.Math.RandomDataGenerator();this.y=-this.height;this.x=isBoss?((getNum(game.canvas.width)/2)-(this.displayWidth/2)):positionX;this.canvasHeight=getNum(game.canvas.height);this.destinationY=this.canvasHeight-200;this.health_bar=new HealthBar(scene,this.x-25+this.width/2,this.y-100);var gap=getNum(game.canvas.height)/20;this.scene.tweens.add({targets:this,y:{value:50,duration:350,ease:'easeOutQuad'},repeat:0,delay:isBoss?500:0,onComplete:function(){if(self.scene!=undefined)
{self.canFire=true;self.scene.tweens.add({targets:self,y:{value:self.destinationY,duration:(isBoss?random.integerInRange(1500,2000):random.integerInRange(700,1300))*gap,ease:'easeOutQuad'},onUpdate:function(tween){self.health_bar.updatePositionY(self.y-10)},});}}});this.scene.add.existing(this);this.scene.physics.add.existing(this);this.index=scene.addEnemy(this);}
selectTarget()
{if(this.scene==undefined||this.hp<=0)
return;var self=this;var next_fire=this.params.attack_speed*(1-((this.canvasHeight-this.y)/this.canvasHeight)*0.3);this.timer=this.scene.time.addEvent({delay:next_fire/SPEED_FACTOR,callback:this.selectTarget,callbackScope:this});if(!IS_PLAYING)
return;var highest_priority=0;var priority_targets=[];var alive_targets=[];$.each(this.scene.player_ships,function(ship_index,ship){if(ship.player_ship.current_hp>0)
{alive_targets.push(ship_index);if(ship.params.enemy_focus>highest_priority)
{highest_priority=ship.params.enemy_focus;priority_targets=[];priority_targets.push(ship_index);}
else if(ship.params.enemy_focus==highest_priority)
priority_targets.push(ship_index);}});for(var bullet=0;bullet<self.params.bullets;bullet++)
{if(self.params.target=='priority')
{var target_index=Math.floor(Math.random()*priority_targets.length);var target_ship_index=priority_targets[target_index];}
if(self.params.target=='random')
{var target_index=Math.floor(Math.random()*alive_targets.length);var target_ship_index=alive_targets[target_index];}
if(target_ship_index!=undefined)
this.fire(target_ship_index,bullet);}}
fire(target_ship_index,bullet_count)
{var self=this;if(this.scene==undefined||!this.canFire)
return;var projectile=this.scene.physics.add.image(0,0,'enemy-'+this.params.projectile).setAlpha(0);projectile.scale=this.isBoss?0.5:0.25;projectile.damage=this.damage;projectile.x=this.x+(this.displayWidth/2);projectile.y=this.y+(this.displayHeight/2)+10;projectile.from='enemy';projectile.sprite=this.params.projectile_hit;projectile.custom_tint=this.params.tint;projectile.index=this.scene.addProjectile(projectile);projectile.level=player.level+'-'+(BOSS_LEVEL?1:0);projectile.explosion=null;projectile.setDepth(1);if(projectile.custom_tint!=null)
projectile.tint=projectile.custom_tint;var random=new Phaser.Math.RandomDataGenerator();var target_x=random.integerInRange(this.scene.player_ships[target_ship_index].x-this.scene.player_ships[target_ship_index].displayWidth,this.scene.player_ships[target_ship_index].x+this.scene.player_ships[target_ship_index].displayWidth);var target_y=this.scene.player_ships[target_ship_index].y+this.scene.player_ships[target_ship_index].displayHeight+projectile.displayHeight;var duration=Math.abs(target_y-projectile.y)*ENEMY_PROJECTILE_FACTOR;var dx=projectile.x-target_x;var dy=projectile.y-target_y;projectile.rotation=Math.atan2(-dy,-dx)+(Math.PI/2);this.scene.tweens.add({targets:this.scene.projectiles[projectile.index],alpha:{value:1,duration:150,ease:'linear'},x:{value:target_x,duration:duration,ease:'linear'},y:{value:target_y,duration:duration,ease:'linear'},delay:self.params.delay_bullet*bullet_count,repeat:0,onStart:function(){if(player.options.sound)
audio.enemy_fire_effect.play();},onComplete:function(tween,targets){if(targets[0].level==(player.level+'-'+(BOSS_LEVEL?1:0)))
{if(!game.scene.getScene('GameBattle').removeProjectile(targets[0].index))
{debug('==== Enemy projectile NOT REMOVED '+(targets[0]==null)+' '+targets[0].index,3);targets[0].destroy();}}
else
{debug('==== Enemy projectile from previous level removed '+(targets[0]==null)+' '+targets[0].index,3);targets[0].destroy();}}});}
hit(damage)
{if(!PLAYER_IS_ALIVE)
return false;this.current_hp-=damage;this.health_bar.updateAmount(this.current_hp/this.hp*100);if(this.current_hp<=0)
{if(!BOSS_LEVEL)
{var max_enemies=Math.min(Math.floor((player.level-1)/stories[player.current_story].missions[player.current_mission].modifiers.max_enemies_increase_levels)+stories[player.current_story].missions[player.current_mission].modifiers.base_max_enemies,30);var enemies_generate=Math.min(max_enemies,Math.min(Math.floor((player.level-1)/50)+1,5));setTimeout(function(){generateEnemy(enemies_generate,enemies_generate,250);},0);}
if(player.options.sound)
audio.explosion_effect.play();player.enemies_alive--;var explosion=this.scene.getNextAvailableExplosion();if(explosion!=null)
{explosion.setDepth(1);explosion.x=this.body.x+this.body.halfWidth;explosion.y=this.body.y+this.body.halfHeight;explosion.setActive(true);explosion.scale=0.5;explosion.tint='0xA00000';explosion.play('explosion');}
return true;}
return false;}}
function startNewGame()
{$('#main-content').load('./stories.html',function(){$('.info-bar .stat').hide(0);$('.info-bar').addClass('info-bar-on-header');$.each(stories,function(story_id,story){$('.stories').append('<h2>'+story.name+'</h2><p>'+story.description+'</p>');$.each(story.missions,function(mission_id,mission){var html='<div class="mission'+(mission.type=='freeplay'?' mission-freeplay':'')+'" onclick="selectMission(\''+story_id+'\', \''+mission_id+'\')"><span class="name">'+mission.name+'</span><span class="description">'+mission.description+'</span>';html+='<div class="difficulties">';html+='<span class="label">Difficulties completed:</span>';if((player.mission_max_level[story_id+'-'+mission_id+'-0']||0)>=mission.required_level)
html+='<span class="difficulty difficulty-normal">Normal</span>';else
html+='<span class="difficulty mission-not-completed">None</span>';if((player.mission_max_level[story_id+'-'+mission_id+'-1']||0)>=mission.required_level)
html+='<span class="difficulty difficulty-hard">Hard</span>';if((player.mission_max_level[story_id+'-'+mission_id+'-2']||0)>=mission.required_level)
html+='<span class="difficulty difficulty-insane">Insane</span>';html+='</div>';html+='<div class="info"><span class="value">Ship slots: <span>'+mission.hero_slots+'</span></span>';if(mission.type=='standard')
{html+='<span class="value">Required stage: <span>'+mission.required_level+'</span></span>';html+='<span class="value">&nbsp;</span>';}
else if(mission.type=='freeplay')
html+='<span class="value value-2x">Highest stage: <span>'+(player.mission_max_level[story_id+'-'+mission_id+'-0']||0)+' / '+(player.mission_max_level[story_id+'-'+mission_id+'-1']||0)+' / '+(player.mission_max_level[story_id+'-'+mission_id+'-2']||0)+'</span></span>';html+='<span class="value">Ship DPS: <span>'+mission.modifiers.hero_dps+'x</span></span>';html+='<span class="value">Ship Health: <span>'+mission.modifiers.hero_health+'x</span></span>';html+='<span class="value">XP Gain: <span>'+mission.modifiers.xp_gain+'x</span></span>';html+='<span class="value">Enemy DPS: <span>'+mission.modifiers.enemy_dps+'x</span></span>';html+='<span class="value">Enemy Health: <span>'+mission.modifiers.enemy_health+'x</span></span>';html+='</div></div>';$('.stories').append(html);});});});}
function selectMission(story_id,mission_id)
{$('#main-content').load('./select-mission.html',function(){var story=stories[story_id];var mission=story.missions[mission_id];var highest_difficulty=0;$('.stories').append('<h2>'+story.name+'</h2><p>'+story.description+'</p>');var html='<div class="mission mission-not-selectable"><span class="name">'+mission.name+'</span><span class="description">'+mission.description+'</span>';html+='<div class="difficulties">';html+='<span class="label">Difficulties completed:</span>';if((player.mission_max_level[story_id+'-'+mission_id+'-0']||0)>=mission.required_level)
{highest_difficulty=1;html+='<span class="difficulty difficulty-normal">Normal</span>';}
else
html+='<span class="difficulty mission-not-completed">None</span>';if((player.mission_max_level[story_id+'-'+mission_id+'-1']||0)>=mission.required_level)
{highest_difficulty=2;html+='<span class="difficulty difficulty-hard">Hard</span>';}
if((player.mission_max_level[story_id+'-'+mission_id+'-2']||0)>=mission.required_level)
html+='<span class="difficulty difficulty-insane">Insane</span>';html+='</div>';html+='<div class="info"><span class="value">Ship slots: <span>'+mission.hero_slots+'</span></span>';if(mission.type=='standard')
{html+='<span class="value">Required stage: <span>'+mission.required_level+'</span></span>';html+='<span class="value">&nbsp;</span>';}
else if(mission.type=='freeplay')
html+='<span class="value value-2x">Highest stage: <span>'+(player.mission_max_level[story_id+'-'+mission_id+'-0']||0)+' / '+(player.mission_max_level[story_id+'-'+mission_id+'-1']||0)+' / '+(player.mission_max_level[story_id+'-'+mission_id+'-2']||0)+'</span></span>';html+='<span class="value">Ship DPS: <span>'+mission.modifiers.hero_dps+'x</span></span>';html+='<span class="value">Ship Health: <span>'+mission.modifiers.hero_health+'x</span></span>';html+='<span class="value">XP Gain: <span>'+mission.modifiers.xp_gain+'x</span></span>';html+='<span class="value">Enemy DPS: <span>'+mission.modifiers.enemy_dps+'x</span></span>';html+='<span class="value">Enemy Health: <span>'+mission.modifiers.enemy_health+'x</span></span>';html+='<span class="value">&nbsp;</span>';html+='<span class="mission-bonuses'+((player.mission_max_level[story_id+'-'+mission_id+'-0']||0)>=mission.required_level||mission.type!='standard'?' mission-bonuses-hidden':'')+'">';html+='<span class="value value-bonus">Bonus points: <span>'+mission.upgrade_points+'</span></span>';html+='<span class="value value-bonus">Bonus XP: <span>'+mission.bonus_xp+'</span></span>';html+='</span>';html+='</div></div>';$('.stories').append(html);for(var i=0;i<mission.hero_slots;i++)
$('.hero-slots').append('<div class="hero" id="hero-'+i+'" onclick="selectHero('+i+');"><span class="select-text">Select ship</span></div>');$.each(player.heroes_list,function(hero_index,hero){hero.updateSelfStatsNoGlobalBonus();var html='<div class="hero" data-hero_id="'+hero_index+'"><div class="image"><img src="support/images/heroes/'+ship_stats[hero.id].image+'" /></div><span class="name">'+ship_stats[hero.id].name+'<span class="selected-text">selected</span></span>';html+='<div class="statistics"><span class="statistic">Attack <span>'+hero.selfStatsNoGlobalBonus.damage+'</span></span>';html+='<span class="statistic">Health <span>'+hero.selfStatsNoGlobalBonus.health+'</span></span>';if(ship_stats[hero.id].base_attack>0)
{html+='<span class="statistic">Attack speed <span>'+(hero.selfStatsNoGlobalBonus.attackSpeed/1000).toFixedNumber(2)+'</span></span>';html+='<span class="statistic">DPS <span>'+(hero.selfStatsNoGlobalBonus.damage/(hero.selfStatsNoGlobalBonus.attackSpeed/1000)).toFixedNumber(2)+'</span></span>';html+='<span class="statistic">Attack mode <span>'+ship_stats[hero.id].attack+'</span></span>';}
html+='<span class="statistic">Enemy focus <span>'+ship_stats[hero.id].enemy_focus+'</span></span>';html+='<span class="statistic">Manual rounds <span>'+hero.getMaxRounds()+'</span></span>';html+='<span class="statistic">Dmg reduction <span>'+hero.selfStatsNoGlobalBonus.damageReduction+'</span></span>';html+='</div></div>';$('.available-heroes').append(html).hide(0);});$('.stories-container a.start-mission').data('story-id',story_id).data('mission-id',mission_id).hide(0).html('Start mission');$('.stories-container .start-mission-level-select').hide(0);selectMissionDifficulty(highest_difficulty);if((player.mission_max_level[story_id+'-'+mission_id+'-0']||0)<mission.required_level)
{$('.stories-container .difficulty .difficulty-hard').hide(0);$('.stories-container .difficulty .difficulty-insane').hide(0);}
if((player.mission_max_level[story_id+'-'+mission_id+'-1']||0)<mission.required_level)
$('.stories-container .difficulty .difficulty-insane').hide(0);});}
function selectMissionDifficulty(difficulty)
{var story_id=$('.stories-container a.start-mission').data('story-id');var mission_id=$('.stories-container a.start-mission').data('mission-id');difficulty=Math.min(2,Math.max(0,difficulty));if((player.mission_max_level[story_id+'-'+mission_id+'-0']||0)<stories[story_id].missions[mission_id].required_level)
difficulty=0;else if((player.mission_max_level[story_id+'-'+mission_id+'-1']||0)<stories[story_id].missions[mission_id].required_level)
difficulty=Math.min(difficulty,1);$('.stories-container .difficulty .difficulty-option').addClass('difficulty-inactive');$('.stories-container .difficulty .difficulty-option:eq('+difficulty+')').removeClass('difficulty-inactive');$('.stories-container .difficulty').data('difficulty',difficulty);if((player.mission_max_level[story_id+'-'+mission_id+'-'+difficulty]||0)>=stories[story_id].missions[mission_id].required_level||stories[story_id].missions[mission_id].type!='standard')
$('.mission-bonuses').addClass('mission-bonuses-hidden');else
{$('.mission-bonuses').removeClass('mission-bonuses-hidden');var html='<span class="value value-bonus">Bonus points: <span>'+(stories[story_id].missions[mission_id].upgrade_points*(difficulty+1))+'</span></span>';html+='<span class="value value-bonus">Bonus XP: <span>'+(stories[story_id].missions[mission_id].bonus_xp*(difficulty+1))+'</span></span>';$('.mission-bonuses').html(html);}
if(stories[story_id].missions[mission_id].type=='freeplay')
missionChangeStartPercentage(-1);}
function missionChangeStartPercentage(value)
{var story_id=$('.stories-container a.start-mission').data('story-id');var mission_id=$('.stories-container a.start-mission').data('mission-id');var mission_difficulty=$('.stories-container .difficulty').data('difficulty');var skip_to_level=0;var skip_to_level_percentage=90;if(value==-1)
{skip_to_level_percentage=player.mission_last_skippable_level_percentage[story_id+'-'+mission_id+'-'+mission_difficulty]||90;skip_to_level_percentage=Math.max(10,Math.min(skip_to_level_percentage,90));$('.stories-container a.start-mission-at-90pc').data('start-level-percentage',skip_to_level_percentage);skip_to_level=Math.floor((player.mission_max_level[story_id+'-'+mission_id+'-'+mission_difficulty]||0)*(skip_to_level_percentage/100)/10)*10;}
else
{skip_to_level_percentage=$('.stories-container a.start-mission-at-90pc').data('start-level-percentage');skip_to_level_percentage=Math.min(90,Math.max(10,skip_to_level_percentage+value));$('.stories-container a.start-mission-at-90pc').data('start-level-percentage',skip_to_level_percentage);skip_to_level=Math.floor((player.mission_max_level[story_id+'-'+mission_id+'-'+mission_difficulty]||0)*(skip_to_level_percentage/100)/10)*10;}
if((player.mission_max_level[story_id+'-'+mission_id+'-'+mission_difficulty]||0)>=stories[story_id].missions[mission_id].required_level)
{$('.stories-container .start-mission-level-select').show(0);$('.stories-container a.start-mission-at-90pc').html('Start mission on stage '+(skip_to_level+1)+' <span class="percent">('+skip_to_level_percentage+'%)</span>');}
else
$('.stories-container .start-mission-level-select').hide(0);}
function autoFillShips()
{$('.available-heroes .hero').data('disabled','0').removeClass('hero-selected');$('.hero-slots .hero').each(function(selected_hero_index,selected_hero){var rand=Math.floor(Math.random()*$('.available-heroes .hero:not(.hero-selected)').length);var selected=$('.available-heroes .hero:not(.hero-selected)').eq(rand);var hero_id=$(selected).data('hero_id');$('#hero-'+selected_hero_index).data('hero_id',hero_id);$('#hero-'+selected_hero_index).html('<span class="image-helper"></span><img src="support/images/heroes/'+ship_stats[player.heroes_list[hero_id].id].image+'" />');$(selected).data('disabled','1').addClass('hero-selected');});$('.stories-container a.start-mission').show(0);var story_id=$('.stories-container a.start-mission').data('story-id');var mission_id=$('.stories-container a.start-mission').data('mission-id');if(stories[story_id].missions[mission_id].type=='freeplay')
missionChangeStartPercentage(-1);}
function selectHero(slot_id)
{$('.available-heroes .hero').data('disabled','0').removeClass('hero-selected');$('.available-heroes .hero').each(function(index,hero){$('.hero-slots .hero').each(function(selected_hero_index,selected_hero){if($(hero).data('hero_id')==$(selected_hero).data('hero_id')&&slot_id!=selected_hero_index)
$(hero).data('disabled','1').addClass('hero-selected');});});$('.available-heroes').center().fadeIn(500);$('.available-heroes .hero').off('click');$('.available-heroes .hero').on('click',function(){if($(this).data('disabled')=='1')
return;var hero_id=$(this).data('hero_id');$('#hero-'+slot_id).data('hero_id',hero_id);$('#hero-'+slot_id).html('<span class="image-helper"></span><img src="support/images/heroes/'+ship_stats[player.heroes_list[hero_id].id].image+'" />');$('.available-heroes').fadeOut(500);$('.stories-container a.start-mission').show(0);var story_id=$('.stories-container a.start-mission').data('story-id');var mission_id=$('.stories-container a.start-mission').data('mission-id');if(stories[story_id].missions[mission_id].type=='freeplay')
missionChangeStartPercentage(-1);});}
function startMission(skip_levels)
{player.current_story=$('.stories-container a.start-mission').data('story-id');player.current_mission=$('.stories-container a.start-mission').data('mission-id');player.current_difficulty=$('.stories-container .difficulty').data('difficulty');player.current_heroes=[];player.mission_start_time=Math.floor(Date.now()/1000);player.repeating_level=false;$('.game-window .information .level').removeClass('level-repeat');var hero_id=0;var total_dps=0;$('.hero-slots .hero').each(function(selected_hero_index,selected_hero){hero_id=$(selected_hero).data('hero_id');if(hero_id!=undefined)
{player.current_heroes.push(hero_id);player.heroes_list[hero_id].slot_position=selected_hero_index;total_dps+=ship_stats[player.heroes_list[hero_id].id].base_attack;}});if(total_dps==0)
alert_message('Please have at least one DPS Ship on your formation',5000,'warning');else
{if(stories[player.current_story].missions[player.current_mission].type=='freeplay'&&skip_levels)
{var skip_to_level_percentage=$('.stories-container a.start-mission-at-90pc').data('start-level-percentage');skip_to_level_percentage=Math.min(90,Math.max(10,skip_to_level_percentage));var skip_to_level=Math.floor((player.mission_max_level[player.current_story+'-'+player.current_mission+'-'+player.current_difficulty]||0)*(skip_to_level_percentage/100)/10)*10;var max_skippable_level=Math.floor((player.mission_max_level[player.current_story+'-'+player.current_mission+'-'+player.current_difficulty]||0)*0.9/10)*10;skip_to_level=Math.max(1,Math.min(skip_to_level,max_skippable_level));if((player.mission_max_level[player.current_story+'-'+player.current_mission+'-'+player.current_difficulty]||0)>=stories[player.current_story].missions[player.current_mission].required_level)
{player.level=(skip_to_level+1);player.mission_last_skippable_level_percentage[player.current_story+'-'+player.current_mission+'-'+player.current_difficulty]=skip_to_level_percentage;}}
continueGame();}}
function continueGame()
{if(IS_PLAYING)
return;IS_PLAYING=true;$('.info-bar .stat').hide(0);$('.info-bar').addClass('info-bar-on-header');(game.scene.getScene('ParallaxBG')).setVisible(false);(game.scene.getScene('GameBG')).setBackground(stories[player.current_story].missions[player.current_mission].backgrounds);(game.scene.getScene('GameBattle')).setVisible(true);}
function continueGameAux()
{$('#main-content').load('./game-window.html',function(){$('.ship-information .close').click(function(){$('.ship-information').fadeOut(300);});$('.mission-text-box').stop(true,false).off();$('.mission-text-box').click(function(){$(this).stop().fadeOut(500)});$(player.current_heroes).each(function(index,hero_idx){player.heroes_list[hero_idx].enabled=true;});updateBonuses();saveGame();PLAYER_IS_ALIVE=true;IS_PLAYING=true;if(player.repeating_level)
$('.game-window .information .level').addClass('level-repeat');$('.game-window .ships').html('').css({width:player.current_heroes.length*210});$(player.current_heroes).each(function(index,hero_idx){new PlayerShip(game.scene.getScene('GameBattle'),hero_idx);});gameloop=setInterval(mainGameLoop,100/SPEED_FACTOR);tutorial_message('gameplay-end-mission');$('#stat-xp span').hide(0);$('#stat-points span').hide(0);$('.info-bar .journal').show(0);$('.journal-container #journal-content').html('');$('.info-bar').removeClass('info-bar-on-header');$('.header').hide(0);updateMissionStory();tutorial_message('first-mission');});}
function showCompleteMission()
{var unlock_points=0;var bonus_xp=0;if((player.mission_max_level[player.current_story+'-'+player.current_mission+'-'+(player.current_difficulty||0)]||0)<stories[player.current_story].missions[player.current_mission].required_level&&player.level>stories[player.current_story].missions[player.current_mission].required_level)
{unlock_points=stories[player.current_story].missions[player.current_mission].upgrade_points*((player.current_difficulty||0)+1);bonus_xp=stories[player.current_story].missions[player.current_mission].bonus_xp*((player.current_difficulty||0)+1);}
$('.complete-mission').center().fadeIn(500);$('.complete-mission #cm-mission-name').html(stories[player.current_story].missions[player.current_mission].name);$('.complete-mission #cm-mission-description').html(stories[player.current_story].missions[player.current_mission].description);$('.complete-mission #cm-total-xp').html((bonus_xp>0?bonus_xp+' + ':'')+player.current_credits);$('.complete-mission #cm-foes-killed').html(player.targets_destroyed);var playtime=player.mission_start_time==undefined?0:Math.floor(Date.now()/1000)-player.mission_start_time;$('.complete-mission #cm-time-played').html(timestampToText(playtime));if(unlock_points==0)
$('.complete-mission #cm-new-points').parent().hide(0);else
{$('.complete-mission #cm-new-points').parent().show(0);$('.complete-mission #cm-new-points').html(unlock_points);}
$('.complete-mission #complete-mission-bonuses').html('');if(stories[player.current_story].missions[player.current_mission]=='standard')
{if((player.mission_max_level[player.current_story+'-'+player.current_mission+'-'+(player.current_difficulty||0)]||0)<stories[player.current_story].missions[player.current_mission].required_level)
$('.complete-mission #complete-mission-bonuses').html('You have previously completed this mission. No unlocks will be rewarded.');else if(!BOSS_LEVEL&&player.level<=stories[player.current_story].missions[player.current_mission].required_level)
$('.complete-mission #complete-mission-bonuses').html('You must complete stage <span class="value">'+stories[player.current_story].missions[player.current_mission].required_level+'</span> to unlock the mission rewards.');else
$('.complete-mission #complete-mission-bonuses').html('You will also unlock the mission rewards.');}}
function hideCompleteMission()
{$('.complete-mission').fadeOut(500);}
function hideMissionLevelReached()
{$('.mission-level-reached').fadeOut(500);}
function completeMission()
{clearTimeout(restartTimer);$('.ships-disabled').fadeOut(150);hideCompleteMission();hideMissionLevelReached();$('.mission-completed .text').html('');var points=0;var bonus_xp=0;if((player.mission_max_level[player.current_story+'-'+player.current_mission+'-'+(player.current_difficulty||0)]||0)<stories[player.current_story].missions[player.current_mission].required_level&&player.level>stories[player.current_story].missions[player.current_mission].required_level)
{points=stories[player.current_story].missions[player.current_mission].upgrade_points*(getNum(player.current_difficulty)+1);bonus_xp=stories[player.current_story].missions[player.current_mission].bonus_xp*(getNum(player.current_difficulty)+1);}
if(points>0)
$('.mission-completed .text').append('<p>You have earned <span class="orange">'+points+'</span> points.</p>');if((player.mission_max_level[player.current_story+'-'+player.current_mission+'-'+(player.current_difficulty||0)]||0)<stories[player.current_story].missions[player.current_mission].required_level&&player.level>stories[player.current_story].missions[player.current_mission].required_level&&stories[player.current_story].missions[player.current_mission].type=='standard')
{var html_unlocks='';$.each(stories[player.current_story].missions[player.current_mission].unlocks,function(idx,unlock){switch(unlock)
{case'hero-2':var ship_unlocked=false;$.each(player.heroes_list,function(ship_index,player_ship){if(player_ship.id=='hero-2')
ship_unlocked=true;});if(!ship_unlocked)
{player.heroes_list.push(new Hero('hero-2'));html_unlocks='<p><span class="orange">'+ship_stats['hero-2'].name+'</span> ship</p>';}
break;case'hero-3':var ship_unlocked=false;$.each(player.heroes_list,function(ship_index,player_ship){if(player_ship.id=='hero-3')
ship_unlocked=true;});if(!ship_unlocked)
{player.heroes_list.push(new Hero('hero-3'));html_unlocks='<p><span class="orange">'+ship_stats['hero-3'].name+'</span> ship</p>';}
break;case'common-item':var equipment=generateEquipment(-1,false,false);if(equipment!=false)
html_unlocks='<p><span class="orange">'+equipment.slot+'</span> for <span class="orange">'+equipment.hero+'</span></p>';break;}});if(html_unlocks!='')
$('.mission-completed .text').append('<p>You have also earned the following unlocks:</p>'+html_unlocks);}
if(player.level>stories[player.current_story].missions[player.current_mission].required_level&&stories[player.current_story].missions[player.current_mission].type=='standard')
player.milestones.missions_completed=(player.milestones.missions_completed||0)+1;if(stories[player.current_story].missions[player.current_mission].type=='freeplay')
{if(player.level>50)
player.milestones.freeplay_completed=(player.milestones.freeplay_completed||0)+1;if((player.level-1)>(player.mission_max_level[player.current_story+'-'+player.current_mission+'-'+(player.current_difficulty||0)]||0))
$('.mission-completed .text').append('<p>You have reached a new record of <span>'+(player.level-1)+'</span> stages cleared <span>(+'+((player.level-1)-(player.mission_max_level[player.current_story+'-'+player.current_mission+'-'+(player.current_difficulty||0)]||0))+' stages since previous record.)</span>.</p>');}
if($('.mission-completed .text').html()=='')
$('.mission-completed .text').append('<p>You can now spend the XP earned on leveling up your ships</p>');var playtime=player.mission_start_time==undefined?0:Math.floor(Date.now()/1000)-player.mission_start_time;$('.mission-completed .text').append('<p>You ran this mission for '+timestampToText(playtime)+'</p>');player.milestones.total_play_time=(player.milestones.total_play_time||0)+playtime;IS_PLAYING=false;BOSS_LEVEL=false;current_level_kills=0;(game.scene.getScene('GameBattle')).resetBattle(true);clearInterval(gameloop);target=null;player.mission_max_level[player.current_story+'-'+player.current_mission+'-'+(player.current_difficulty||0)]=Math.max((player.mission_max_level[player.current_story+'-'+player.current_mission+'-'+(player.current_difficulty||0)]||0),(player.level-1));var total_xp=bonus_xp;player.earned_points+=points;player.available_points+=points;player.level=1;player.earned_credits+=total_xp;player.available_credits+=total_xp;player.current_credits=0;player.targets_destroyed=0;player.enemies_alive=0;player.enemies_created=0;player.current_story=null;player.current_mission=null;player.current_heroes=[];player.milestones.xp_earned=(player.milestones.xp_earned||0)+total_xp;player.milestones.points_earned=(player.milestones.points_earned||0)+points;checkAchievementCompleted();saveGame();alert_message('Mission completed!');$('.mission-information-box').hide(0);$('.mission-completed').fadeIn(500);}
function closeCompleteMissionWindow()
{$('.mission-completed').fadeOut(500,function(){showMainMenu(false);});}
function closeNewItemWindow()
{playSelectMenu();$('.new-item').stop(true).fadeOut(500);}
function gameSettings()
{$('#main-content').load('./options.html',function(){$('#option-sfx').html('Sound effects: '+(player.options.sound?'on':'off'));$('#option-bgm').html('Background music: '+(player.options.music?'on':'off'));$('#option-ratio').html('Window ratio: '+(player.options.ratio==2?'9:16':'3:4'));$('#option-speed').html('Game speed: '+(player.options.speed==undefined?1:player.options.speed)+'x');$('#option-notifications').html('Notifications: '+(player.options.notifications?'on':'off'));$('#option-run-background').html('Run on background: '+(player.options.run_background?'on':'off'));$('#option-fps').html('FPS: '+(player.options.fps==undefined?60:player.options.fps));$('.options').hide(0).fadeIn(1500);if(!DEBUG)
$('#option-speed').hide(0);});}
function option_toggle_sfx()
{player.options.sound=!player.options.sound;$('#option-sfx').html('Sound effects: '+(player.options.sound?'on':'off'));}
function option_toggle_music()
{player.options.music=!player.options.music;if(player.options.music)
playBGM('main-menu');else
stopBGM();$('#option-bgm').html('Background music: '+(player.options.music?'on':'off'));}
function option_toggle_ratio()
{player.options.ratio=(player.options.ratio==2?1:2);$('#option-ratio').html('Window ratio: '+(player.options.ratio==2?'9:16':'3:4'));RESTART_REQUIRED=true;reloadPhaserIO();}
function option_toggle_speed()
{player.options.speed=(player.options.speed==undefined?2:player.options.speed+1);if(player.options.speed==6)
player.options.speed=1;SPEED_FACTOR=player.options.speed;$('#option-speed').html('Game speed: '+player.options.speed+'x');}
function option_toggle_notifications()
{player.options.notifications=!player.options.notifications;$('#option-notifications').html('Notifications: '+(player.options.notifications?'on':'off'));}
function option_run_background()
{player.options.run_background=!player.options.run_background;$('#option-run-background').html('Run on background: '+(player.options.run_background?'on':'off'));RESTART_REQUIRED=true;}
function option_fps()
{player.options.fps=player.options.fps==undefined?15:(player.options.fps==15?30:(player.options.fps==30?60:15));$('#option-fps').html('FPS: '+(player.options.fps==undefined?60:player.options.fps));RESTART_REQUIRED=true;}
function option_apply_changes()
{saveGame();alert('Game will now reload');window.location.reload(true);}
function option_export_save()
{$('.options .save-text').show(0);$('.options .save-text a').hide(0);$('.options textarea').val(JSON.stringify(player));}
function option_show_import_save()
{$('.options .save-text').show(0);$('.options .save-text a').show(0);}
function option_import_save()
{if($('.options textarea').val()!='')
{player=JSON.parse($('.options textarea').val());saveGame();alert('Game will now reload');window.location.reload(true);}}
function debug(text,priority)
{if(DEBUG)
{console.log(dateObject.getTime()+' '+text);}}
function playSelectMenu()
{if(player.options.sound)
audio.menu_select_effect.play();}
function playBGM(track)
{if(!player.options.music)
return false;if(audio.bgm_track!=track)
{stopBGM();audio.bgm_track=track;audio.bgm=game.sound.add(track);audio.bgm.loop=1;audio.bgm.setVolume(0.25);audio.bgm.play();}
else if(audio.bgm!=undefined&&!audio.bgm.isPlaying)
audio.bgm.play();}
function stopBGM()
{if(audio.bgm!=undefined)
{if(audio.bgm.isPlaying)
audio.bgm.stop();}}
function confirm_link(message,link)
{if(confirm(message))
window.location=link;}
function alert_message(message,delay,type)
{delay=delay==undefined?1500:delay;type=type==undefined?'information':type;add_notification('',message,type,delay);}
function info_message_box(title,message)
{add_notification(title,message,'standard',10000);}
function add_notification(title,message,type,duration)
{var already_exists=false;if($('.info-message-box').hasClass('visible'))
already_exists=$('.info-message-box p').html()==message;$.each(notifications,function(idx,notification){if(notification.message==message)
{already_exists=true;return;}});if(!already_exists)
{notifications.push({title:title,message:message,type:type,duration:duration});if(!$('.info-message-box').hasClass('visible'))
show_next_notification();}}
function show_next_notification()
{var notification=notifications.shift();if(notification!=undefined)
{$('.info-message-box').removeClass('imb-information imb-warning imb-standard visible').addClass('visible imb-'+notification.type);if(notification.title!='')
$('.info-message-box h3').show(0).html(notification.title);else
$('.info-message-box h3').hide(0);$('.info-message-box p').html(notification.message);$('.info-message-box').show(0).css({opacity:0,top:-$(this).height(),width:$('.header').width()-40}).animate({top:0,opacity:1},500);if(notification.duration>0)
$('.info-message-box').delay(notification.duration).fadeOut(500,function(){$('.info-message-box').removeClass('visible');show_next_notification();});}}
function send_push_notification(title,text)
{if(!player.options.notifications||!window.Notification)
return;if(Notification.permission!=="granted")
Notification.requestPermission();else
{var notification=new Notification('Idle War - '+title,{icon:'support/images/logo.jpg',body:text,});}}
function tutorial_message(message_id)
{if(player.tutorial_messages[message_id]==undefined)
{add_notification(tutorial_messages[message_id].title,tutorial_messages[message_id].message,'standard',0);player.tutorial_messages[message_id]=1;}}
function dismiss_notifications()
{$('.notifications').fadeOut(500,function(){$(this).remove()});}
function getEquipmentName(type)
{switch(type)
{case'self-damage-reduction':return'Damage reduction';break;case'global-damage-reduction':return'Global damage reduction';break;case'self-damage':return'Damage increase';break;case'global-damage':return'Global damage increase';break;case'self-attack-speed':return'Attack speed';break;case'global-attack-speed':return'Global attack speed';break;case'global-xp-boost':return'XP boost';break;case'self-hp':return'Health increase';break;case'global-hp':return'Global health increase';break;case'global-hp-plus-global-attack-speed-minus':return'Armor stasis field';break;case'enemy-hp-plus-global-damage-reduction-minus':return'Aggressive stance';break;case'self-damage-plus-self-hp-minus':return'Smart projectiles';break;}}
function getEquipmentTypeDescription(equipment,slot)
{var multiplier=qualities[slot.quality].multiplier;switch(equipment.type)
{case'self-damage-reduction':return'Reduces damage taken for the current ship '+(equipment.value*multiplier).toFixedNumber(2)+'hp per level ('+(equipment.value*slot.level*multiplier).toFixedNumber(2)+'hp)';break;case'global-damage-reduction':return'Reduces damage taken for all ships by '+(equipment.value*multiplier).toFixedNumber(2)+'hp per level ('+(equipment.value*slot.level*multiplier).toFixedNumber(2)+'hp)';break;case'self-damage':return'Increases damage for the current ship by '+(equipment.value*multiplier).toFixedNumber(2)+'% per level ('+(equipment.value*slot.level*multiplier).toFixedNumber(2)+'%)';break;case'global-damage':return'Increases damage for all ships ship '+(equipment.value*multiplier).toFixedNumber(2)+'% per level ('+(equipment.value*slot.level*multiplier).toFixedNumber(2)+'%)';break;case'self-attack-speed':return'Increases attack speed for the current ship by '+(equipment.value*multiplier).toFixedNumber(2)+'% per level ('+(equipment.value*slot.level*multiplier).toFixedNumber(2)+'%)';break;case'global-attack-speed':return'Increases attack speed for all ships by '+(equipment.value*multiplier).toFixedNumber(2)+'% per level ('+(equipment.value*slot.level*multiplier).toFixedNumber(2)+'%)';break;case'global-xp-boost':return'Increases XP received by '+(equipment.value*multiplier).toFixedNumber(2)+'% per level ('+(equipment.value*slot.level*multiplier).toFixedNumber(2)+'%)';break;case'self-hp':return'Increases health for the current ship by '+(equipment.value*multiplier).toFixedNumber(2)+'% per level ('+(equipment.value*slot.level*multiplier).toFixedNumber(2)+'%)';break;case'global-hp':return'Increases health for all ships by '+(equipment.value*multiplier).toFixedNumber(2)+'% per level ('+(equipment.value*slot.level*multiplier).toFixedNumber(2)+'%)';break;case'global-hp-plus-global-attack-speed-minus':var text='Increases health for all ships by '+(equipment.values[0]*multiplier).toFixedNumber(2)+'% per level ('+(equipment.values[0]*slot.level*multiplier).toFixedNumber(2)+'%)';text+='<br />Reduces attack speed for all ships by '+(equipment.values[1]*multiplier).toFixedNumber(2)+'% per level ('+(equipment.values[1]*slot.level*multiplier).toFixedNumber(2)+'%)';return text;break;case'enemy-hp-plus-global-damage-reduction-minus':var text='Reduces enemies HP by '+(equipment.values[0]*multiplier).toFixedNumber(2)+'hp per level ('+(equipment.values[0]*slot.level*multiplier).toFixedNumber(2)+'hp)';text+='<br />Reduces damage reduction bonus for all ships by '+(equipment.values[1]*multiplier).toFixedNumber(2)+'hp per level ('+(equipment.values[1]*slot.level*multiplier).toFixedNumber(2)+'hp)';return text;break;case'self-damage-plus-self-hp-minus':var text='Increases damage for the current ship by '+(equipment.values[0]*multiplier).toFixedNumber(2)+'% per level ('+(equipment.values[0]*slot.level*multiplier).toFixedNumber(2)+'%)';text+='<br />Reduces health for the current ship by '+(equipment.values[1]*multiplier).toFixedNumber(2)+'% per level ('+(equipment.values[1]*slot.level*multiplier).toFixedNumber(2)+'%)';return text;break;}}
function value_to_smart_notation(value)
{if(value>=1000000)
return value.toExponential(2).replace('+','');else
return value;}
function refillShipRounds(player_ship_id)
{player.heroes_list[player_ship_id].refillRounds();$('.game-window .ships .ship#ship-'+player_ship_id+' .fire-container .rounds').removeClass('rounds-empty').html(player.heroes_list[player_ship_id].rounds);}
function hit_foe(enemy,damage,hero_id)
{if(enemy.hit(damage))
{debug('Calculating XP earned. From upgrades: '+bonuses['global-xp-boost']);var credits=Math.max(1,Math.floor(player.level*0.25));if(BOSS_LEVEL)
credits=credits*5;credits=credits*(1+bonuses['global-xp-boost']+stories[player.current_story].missions[player.current_mission].modifiers.xp_gain);credits=Math.floor(credits*((player.current_difficulty||0)+1));if(player.repeating_level)
credits=Math.ceil(credits/10);$('.information .credits .increment').html('+'+credits).stop().fadeIn(250).delay(500).fadeOut(500);player.current_credits+=credits;player.earned_credits+=credits;player.available_credits+=credits;if(!BOSS_LEVEL)
current_level_kills++;else
{if(player.enemies_alive<=0)
{player.targets_destroyed+=current_level_kills;player.enemies_created=0;var hero_index=-1;$(player.heroes_list).each(function(index,hero){if(hero.id==hero_id)
{hero_index=index;return false;}});var equipment=generateEquipment(hero_index,true,false);if(equipment!=false)
{$('#ni-ship').html(equipment.hero);$('#ni-name').html(equipment.name);$('#ni-stats').html(equipment.stats);$('.new-item').fadeIn(300).delay(10000).fadeOut(300);$('.journal-container #journal-content').append('<p class="equipment-text">Equipment found for '+equipment.hero+' with a probability of '+equipment.probability+'%.<br />'+equipment.name+'<br />'+equipment.stats+'</p>');}
(game.scene.getScene('GameBattle')).resetBattle(false);IS_PLAYING=false;(game.scene.getScene('GameBattle')).newLevelAnimation();player.level++;player.repeating_level=false;$('.game-window .information .level').removeClass('level-repeat');if(stories[player.current_story].missions[player.current_mission].type=='freeplay')
player.milestones.freeplay_highest_level=Math.max(player.milestones.freeplay_highest_level||0,player.level-1);player.milestones.levels_completed=(player.milestones.levels_completed||0)+1;checkAchievementCompleted();updateMissionStory();if(player.level==(stories[player.current_story].missions[player.current_mission].required_level+1)&&stories[player.current_story].missions[player.current_mission].type=='standard')
$('.mission-level-reached').center().fadeIn(500);(game.scene.getScene('GameBG')).loadBackground();saveGame();BOSS_LEVEL=false;}}
return true;}
return false;}
function generateEquipment(hero_idx,random,existing_only)
{if(hero_idx==-1)
hero_idx=Math.floor(Math.random()*player.heroes_list.length);var equipment_id=getEquipmentGeneratedID(hero_idx,existing_only);if(random)
{if(player.level>(player.mission_max_level[player.current_story+'-'+player.current_mission+'-'+player.current_difficulty]||0)&&(player.level<=stories[player.current_story].missions[player.current_mission].required_level||stories[player.current_story].missions[player.current_mission].type=='freeplay'))
random=false;}
var probability=BASE_DROP_RATE_PROBABILITY+(bonuses['equipment-drop-rate']*100);debug('Attempting to generate equipment with probability of '+(random?probability:100),0);if(!random||Math.floor(Math.random()*100)<probability)
{if(player.heroes_list[hero_idx].equipment_found[equipment_id]==undefined)
player.heroes_list[hero_idx].equipment_found[equipment_id]={level:1,quality:0};else
player.heroes_list[hero_idx].equipment_found[equipment_id].level++;updateBonuses();tutorial_message('first-equipment');return{hero:ship_stats[player.heroes_list[hero_idx].id].name,name:getEquipmentName(ship_stats[player.heroes_list[hero_idx].id].equipment[equipment_id].type)+' level <span class="orange">'+player.heroes_list[hero_idx].equipment_found[equipment_id].level+'</span>',stats:getEquipmentTypeDescription(ship_stats[player.heroes_list[hero_idx].id].equipment[equipment_id],player.heroes_list[hero_idx].equipment_found[equipment_id]),probability:(random?probability:100),equipment_id:equipment_id};}
else
return false;}
function getEquipmentGeneratedID(hero_idx,existing_only)
{var select_lowest=Math.floor(Math.random()*100)<30;if(existing_only)
{if(select_lowest)
{var level=null;var equipment_id=null;$.each(player.heroes_list[hero_idx].equipment_found,function(eqp_id,equipment_piece){if(level==null||equipment.level<level)
{level=equipment_piece.level;equipment_id=eqp_id;}});}
else
{var equipment_id=Math.floor(Math.random()*Object.keys(player.heroes_list[hero_idx].equipment_found).length);equipment_id=Object.keys(player.heroes_list[hero_idx].equipment_found)[equipment_id];}}
else
{if(select_lowest)
{var level=null;var equipment_id=null;$.each(ship_stats[player.heroes_list[hero_idx].id].earnable_equipment,function(id,eqp_id){var equipment_level=player.heroes_list[hero_idx].equipment_found[eqp_id]==undefined?0:player.heroes_list[hero_idx].equipment_found[eqp_id].level;if(level==null||equipment_level<level)
{level=equipment_level;equipment_id=eqp_id;}});}
else
{var equipment_id=Math.floor(Math.random()*ship_stats[player.heroes_list[hero_idx].id].earnable_equipment.length);equipment_id=ship_stats[player.heroes_list[hero_idx].id].earnable_equipment[equipment_id];}}
var current_level=player.heroes_list[hero_idx].equipment_found[equipment_id]==undefined?1:player.heroes_list[hero_idx].equipment_found[equipment_id].level;if(ship_stats[player.heroes_list[hero_idx].id].equipment[equipment_id].max_level==0||current_level<ship_stats[player.heroes_list[hero_idx].id].equipment[equipment_id].max_level)
return equipment_id;else
return getEquipmentGeneratedID(hero_idx,existing_only);}
function getNum(val)
{if(val==undefined)
return 0;else
return parseInt(val);}
function getValue(val,decimal_places)
{if(val==undefined)
return 0;else
return val.toFixedNumber(decimal_places);}
function timestampToText(seconds)
{var measuredTime=new Date(null);measuredTime.setSeconds(seconds);return measuredTime.toISOString().substr(11,8);}
function showMainMenu(play_sound)
{if(RESTART_REQUIRED)
{saveGame();alert('.');window.location.reload(true);}
tutorial_message('menu-welcome');if(play_sound)
playSelectMenu();if(game.scene.isVisible('GameBG'))
{game.scene.stop('GameBG');game.scene.stop('GameBattle');}
if(!game.scene.isVisible('ParallaxBG'))
(game.scene.getScene('ParallaxBG')).setVisible(true);playBGM('main-menu');$('#main-content').load('./menu.html',function(){if(player.current_story!=null)
{$('#menu-start-game').hide(0);$('#menu-continue-game').show(0);}
else
{$('#menu-start-game').show(0);$('#menu-continue-game').hide(0);}
$('#stat-xp span').html(value_to_smart_notation(player.available_credits)).show(0);$('#stat-points span').html(getNum(player.available_points)).show(0);$('.home-navigation').fadeIn(1500);$('.info-bar .stat').show(0);$('.info-bar').show(0).removeClass('info-bar-on-header');$('.info-bar .journal').hide(0);$('.header').show(0);$('#menu-ships .level-up').hide(0)
$(player.heroes_list).each(function(index,hero){if(hero.getEfficiencyCost()<=player.available_credits)
$('#menu-ships .level-up').show(0)});});IS_PLAYING=false;BOSS_LEVEL=false;clearInterval(gameloop);target=null;player.enemies_created=0;player.enemies_alive=0;$(player.heroes_list).each(function(index,hero){player.heroes_list[index].enabled=false;});updateBonuses();(game.scene.getScene('GameBattle')).resetBattle(true);saveGame();}
function aboutTheGame(play_sound)
{$('#main-content').load('./about.html',function(){});}
function bonus_icon_image(type)
{return'<img src="support/images/bonuses/'+bonus_icons[type].image+'" />';}
function toggleJournal()
{$('.journal-container').toggle(0);}
function gameWindowToggleCredits()
{if($('.game-window .credits .mission-xp').is(':visible'))
{$('.game-window .credits .mission-xp').hide(0);$('.game-window .credits .global-xp').show(0);}
else
{$('.game-window .credits .mission-xp').show(0);$('.game-window .credits .global-xp').hide(0);}}
function updateMissionStory()
{if(stories[player.current_story].missions[player.current_mission].messages!=undefined)
{var id=-1;var text='';$.each(stories[player.current_story].missions[player.current_mission].messages,function(index,message){if(index<=player.level)
{id=index;text=message.text;}});if(id==-1)
{id=Object.keys(stories[player.current_story].missions[player.current_mission].messages)[0];text=stories[player.current_story].missions[player.current_mission].messages[id].text;}
if($('.mission-text-box').data('id')!=id)
{$('.journal-container #journal-content').append('<p class="mission-text">'+text+'</p>');$('.mission-text-box').data('id',id);$('.mission-text-box').html(text).fadeIn(500).delay(10000).fadeOut(500);}}
else
{$('.mission-text-box').data('id',-1);$('.mission-text-box').html('Mission text not available...');}}
function viewStatistics()
{$('#main-content').load('./statistics.html',function(){$('.bonuses-container #bonuses-missions_completed').html(getValue(player.milestones.missions_completed,0));$('.bonuses-container #bonuses-freeplay_completed').html(getValue(player.milestones.freeplay_completed,0));$('.bonuses-container #bonuses-freeplay_highest_level').html(getValue(player.milestones.freeplay_highest_level,0));$('.bonuses-container #bonuses-levels_completed').html(getValue(player.milestones.levels_completed,0));$('.bonuses-container #bonuses-total_kills').html(getValue(player.milestones.total_kills,0));$('.bonuses-container #bonuses-total_boss_kills').html(getValue(player.milestones.total_boss_kills,0));$('.bonuses-container #bonuses-total_damage_given').html(getValue(player.milestones.total_damage_given,0));$('.bonuses-container #bonuses-total_damage_received').html(getValue(player.milestones.total_damage_received,2));$('.bonuses-container #bonuses-total_damage_prevented').html(getValue(player.milestones.total_damage_prevented,2));$('.bonuses-container #bonuses-total_hp_healed').html(getValue(player.milestones.total_hp_healed,2));$('.bonuses-container #bonuses-hits_on_enemy').html(getValue(player.milestones.hits_on_enemy,2));$('.bonuses-container #bonuses-hits_on_player_ship').html(getValue(player.milestones.hits_on_player_ship,2));$('.bonuses-container #bonuses-total_play_time').html(timestampToText(player.milestones.total_play_time||0));$('.bonuses-container #bonuses-stargazer_kills').html(getValue(player.milestones.stargazer_kills,2));$('.bonuses-container #bonuses-stargazer_boss_kills').html(getValue(player.milestones.stargazer_boss_kills,2));$('.bonuses-container #bonuses-stargazer_damage_given').html(getValue(player.milestones.stargazer_damage_given,2));$('.bonuses-container #bonuses-stargazer_damage_received').html(getValue(player.milestones.stargazer_damage_received,2));$('.bonuses-container #bonuses-stargazer_hits_on_enemy').html(getValue(player.milestones.stargazer_hits_on_enemy,2));$('.bonuses-container #bonuses-stargazer_hits_on_player_ship').html(getValue(player.milestones.stargazer_hits_on_player_ship,2));$('.bonuses-container #bonuses-bruiser_kills').html(getValue(player.milestones.bruiser_kills,2));$('.bonuses-container #bonuses-bruiser_boss_kills').html(getValue(player.milestones.bruiser_boss_kills,2));$('.bonuses-container #bonuses-bruiser_damage_given').html(getValue(player.milestones.bruiser_damage_given,2));$('.bonuses-container #bonuses-bruiser_damage_received').html(getValue(player.milestones.bruiser_damage_received,2));$('.bonuses-container #bonuses-bruiser_hits_on_enemy').html(getValue(player.milestones.bruiser_hits_on_enemy,2));$('.bonuses-container #bonuses-bruiser_hits_on_player_ship').html(getValue(player.milestones.bruiser_hits_on_player_ship,2));$('.bonuses-container #bonuses-relief_kills').html(getValue(player.milestones.relief_kills,2));$('.bonuses-container #bonuses-relief_boss_kills').html(getValue(player.milestones.relief_boss_kills,2));$('.bonuses-container #bonuses-relief_damage_given').html(getValue(player.milestones.relief_damage_given,2));$('.bonuses-container #bonuses-relief_damage_received').html(getValue(player.milestones.relief_damage_received,2));$('.bonuses-container #bonuses-relief_hp_healed').html(getValue(player.milestones.relief_hp_healed,2));$('.bonuses-container #bonuses-relief_hits_on_enemy').html(getValue(player.milestones.relief_hits_on_enemy,2));$('.bonuses-container #bonuses-relief_hits_on_player_ship').html(getValue(player.milestones.relief_hits_on_player_ship,2));$('.bonuses-container #bonuses-xp_earned').html(getValue(player.milestones.xp_earned,2));$('.bonuses-container #bonuses-points_earned').html(getValue(player.milestones.points_earned,2));$('.bonuses-container #bonuses-achievements_unlocked').html(getValue(player.milestones.achievements_unlocked,2));$('.drop-rates-list').append('<p>Current drop rate for equipment is '+getValue(BASE_DROP_RATE_PROBABILITY+(bonuses['equipment-drop-rate']*100),3)+'% ('+BASE_DROP_RATE_PROBABILITY+'% base + '+(bonuses['equipment-drop-rate']*100)+'% bonus)</p>');});}
function viewChangelog()
{$('#main-content').load('./changelog.html',function(){});}
function reloadPhaserIO()
{RELOADING=true;stopBGM();game.destroy(true,false);phaser_config.scale.width=player.options.ratio==2?750:768;phaser_config.scale.height=player.options.ratio==2?1334:1024;phaser_config.fps.forceSetTimeOut=player.options.run_background==true;game=new Phaser.Game(phaser_config);}
$.fn.center=function(){this.css("position","absolute");this.css("top",($(this.parent()).outerHeight()-this.outerHeight())/2+"px");return this;}
Number.prototype.toFixedNumber=function(x,base){var pow=Math.pow(base||10,x);return Math.round(this*pow)/pow;}
var ENEMY_PROJECTILE_FACTOR=2;var PLAYER_PROJECTILE_FACTOR=1.3;var VERSION=4;var RELOADING=false;var RESTART_REQUIRED=false;var SPEED_FACTOR=1;var NEW_LEVEL_ANIMATION=false;var IS_PLAYING=false;var PLAYER_IS_ALIVE=false;var BOSS_LEVEL=false;var notifications=[];var restartTimer=null;var current_level_kills=0;var audio={};var phaser_config;var game;var save_version=DEBUG?localStorage.getItem('pixeldefenders-game-version'):1;$(document).ready(function(){if(window.Notification&&Notification&&Notification.permission!=="granted")
Notification.requestPermission();if(JSON.parse(localStorage.getItem('pixeldefenders'))!==null)
{player=JSON.parse(localStorage.getItem('pixeldefenders'));if(player.mission_last_skippable_level_percentage==undefined)
player.mission_last_skippable_level_percentage={};if(player.tutorial_messages==undefined)
player.tutorial_messages={};if(player.mission_max_level==undefined)
player.mission_max_level={};if(player.milestones==undefined)
player.milestones={};if(player.achievements==undefined)
player.achievements={};}
else
player=empty_player_structure;if(localStorage.getItem("pixeldefenders")!==null&&save_version!=VERSION)
{}
SPEED_FACTOR=player.options.speed==undefined?1:player.options.speed;phaser_config={type:Phaser.AUTO,title:'Idle War',url:'http://idlewar.oscarolim.pt',scale:{mode:Phaser.Scale.FIT,parent:'game-container',width:player.options.ratio==2?750:768,height:player.options.ratio==2?1334:1024},physics:{default:'arcade',arcade:{debug:false,gravity:{y:0}}},scene:{preload:preload,create:create,update:update},audio:{disableWebAudio:true},fps:{min:10,target:player.options.fps==undefined?60:player.options.fps,forceSetTimeOut:false,deltaHistory:5}};if(player.options.run_background)
phaser_config.fps.forceSetTimeOut=true;game=new Phaser.Game(phaser_config);$('.info-message-box').click(function(){$(this).stop(true,false);$(this).fadeOut(500,function(){$('.info-message-box').removeClass('visible');show_next_notification();});});});function preload()
{var n=dateObject.getTime();var self=this;this.load.sceneFile('ParallaxBG','support/js/scenes/parallax-bg.js?n='+n);this.load.sceneFile('GameBG','support/js/scenes/game-bg.js?n='+n);this.load.sceneFile('GameBattle','support/js/scenes/game-battle.js?n='+n);this.load.audio('main-menu',['support/music/main-menu.ogg','support/music/main-menu.mp3']);this.load.audio('enemy-fire',['support/audio/enemy-fire.ogg','support/audio/enemy-fire.mp3']);this.load.audio('explosion',['support/audio/explosion.ogg','support/audio/explosion.mp3']);$.each(ship_stats,function(hero_index,hero){self.load.audio(hero.projectile_audio,['support/audio/'+hero.projectile_audio+'.ogg','support/audio/'+hero.projectile_audio+'.mp3']);});this.load.audio('menu-select',['support/audio/select.ogg','support/audio/select.mp3']);}
function create()
{var self=this;audio={};audio.menu_select_effect=this.sound.add('menu-select');audio.menu_select_effect.setVolume(0.5);audio.enemy_fire_effect=this.sound.add('enemy-fire');audio.enemy_fire_effect.setVolume(0.1);audio.explosion_effect=this.sound.add('explosion');audio.explosion_effect.setVolume(0.5);$.each(ship_stats,function(hero_index,hero){audio[hero.projectile_audio]=self.sound.add(hero.projectile_audio);audio[hero.projectile_audio].setVolume(0.1);});loadGameEngine();game.scene.start('ParallaxBG');this.scale.on('resize',resize,this);resize();if(RELOADING)
playBGM('main-menu');RELOADING=false;}
function update()
{}
function resize()
{$('.game-container-centered').width(game.canvas.style.width);$('.info-message-box').css({width:$('.header').width()-40});}
var gameloop=null;var target=null;function loadGameEngine()
{if(localStorage.getItem("pixeldefenders")!==null)
{player.enemies_alive=0;current_level_kills=0;$(player.heroes_list).each(function(index,hero){player.heroes_list[index]=new Hero(hero.id);player.heroes_list[index].fromJson(hero);});var unlocked_points=0;var current_progress=0;$.each(achievements,function(upgrade_index,achievement){current_progress=getValue(player.milestones[achievement.tracker],0);if(current_progress>=achievement.requirement)
unlocked_points+=achievement.reward_points;});$.each(player.mission_max_level,function(mission,stage_reached){mission=mission.split('-');if(stage_reached>=stories[mission[0]].missions[mission[1]].required_level)
unlocked_points+=stories[mission[0]].missions[mission[1]].upgrade_points*(getNum(mission[2])+1);});if(unlocked_points!=player.milestones.points_earned)
{player.milestones.points_earned=unlocked_points;player.upgrades={};player.earned_points=unlocked_points;player.available_points=unlocked_points;info_message_box('Upgrade points balance','A recent update changed the amount of upgrade points that are rewarded throughout the game. Your  <span class="purple">Upgrades</span> have been reset and you can now use your point balance of <span class="purple">'+unlocked_points+'</span> to purchase any upgrades available.');}
$('.header').delay(250).fadeIn(1500);$('.welcome-button').delay(500).fadeIn(1500);}
else
initializeGame();}
function mainGameLoop()
{if(!IS_PLAYING)
return;var difficulty_label=player.current_difficulty==0?'Normal':(player.current_difficulty==1?'Hard':'Insane');var required_kills=stories[player.current_story].missions[player.current_mission].kills_required[(player.level-1)%stories[player.current_story].missions[player.current_mission].kills_required.length];$('.game-window .information .kills .text').html('Kills<br />'+current_level_kills+'/'+required_kills);$('.game-window .information .kills .inner-bar').css({width:(current_level_kills/required_kills*100)+'%'});if(stories[player.current_story].missions[player.current_mission].type=='standard')
$('.game-window .information .level .text').html('Stage - '+difficulty_label+'<br />'+player.level+'/'+stories[player.current_story].missions[player.current_mission].required_level);else if(stories[player.current_story].missions[player.current_mission].type=='freeplay')
$('.game-window .information .level .text').html('Stage - '+difficulty_label+'<br />'+player.level);$('.game-window .information .level .inner-bar').css({width:Math.min(player.level/stories[player.current_story].missions[player.current_mission].required_level*100,100)+'%'});$('.game-window .information .credits .mission-xp .current').html('Mission XP<br />'+value_to_smart_notation(player.current_credits));$('.game-window .information .credits .global-xp .current').html('Global XP<br />'+value_to_smart_notation(player.available_credits));if(current_level_kills>=required_kills)
{player.enemies_created=0;player.enemies_alive=0;player.targets_destroyed+=current_level_kills;current_level_kills=0;(game.scene.getScene('GameBattle')).resetBattle(false);if((player.level%stories[player.current_story].missions[player.current_mission].bosses)==0)
BOSS_LEVEL=true;else
{player.level++;player.repeating_level=false;$('.game-window .information .level').removeClass('level-repeat');if(stories[player.current_story].missions[player.current_mission].type=='freeplay')
player.milestones.freeplay_highest_level=Math.max(player.milestones.freeplay_highest_level||0,player.level-1);player.milestones.levels_completed=(player.milestones.levels_completed||0)+1;checkAchievementCompleted();updateMissionStory();$('.game-window .stage-info').html('Reached stage '+player.level).css({left:'-100%'}).animate({left:0},350).delay(1000).animate({left:'100%'},350);(game.scene.getScene('GameBG')).loadBackground();}
IS_PLAYING=false;(game.scene.getScene('GameBattle')).newLevelAnimation();saveGame();return;}
if(BOSS_LEVEL)
$('.game-window .information .kills .text').html('BOSS');if(BOSS_LEVEL&&player.enemies_created==0)
{$('.game-window .stage-info').html('Incoming BOSS!!!').css({left:'-100%'}).animate({left:0},350).delay(1000).animate({left:'100%'},350);player.enemies_created++;player.enemies_alive++;new Enemy(game.scene.getScene('GameBattle'),true);var adds_quantity=2+Math.min(18,Math.floor(player.level/25));setTimeout(function(){generateEnemy(adds_quantity,adds_quantity,250);},0);}
else if(!BOSS_LEVEL&&player.enemies_created==0)
{var enemies_generate=Math.min(Math.floor((player.level-1)/stories[player.current_story].missions[player.current_mission].modifiers.max_enemies_increase_levels)+stories[player.current_story].missions[player.current_mission].modifiers.base_max_enemies,30);setTimeout(function(){generateEnemy(enemies_generate,enemies_generate,250);},0);}}
function generateEnemy(quantity,current_enemy,delay)
{var max_enemies=Math.min(Math.floor((player.level-1)/stories[player.current_story].missions[player.current_mission].modifiers.max_enemies_increase_levels)+stories[player.current_story].missions[player.current_mission].modifiers.base_max_enemies,30);if(current_enemy==0||!IS_PLAYING||player.enemies_alive>max_enemies)
return;var random=new Phaser.Math.RandomDataGenerator();var positionX=random.integerInRange(20,game.canvas.width-80);player.enemies_created++;player.enemies_alive++;new Enemy(game.scene.getScene('GameBattle'),false,positionX);var random_delay=random.integerInRange(delay/2,delay*1.5);setTimeout(function(){generateEnemy(quantity,current_enemy-1,delay);},random_delay);}
function restartLevel()
{clearTimeout(restartTimer);$('.ships-disabled').fadeOut(150);current_level_kills=0;player.enemies_created=0;player.enemies_alive=0;player.repeating_level=true;$('.game-window .information .level').addClass('level-repeat');IS_PLAYING=false;(game.scene.getScene('GameBattle')).resetBattle(false);(game.scene.getScene('GameBattle')).newLevelAnimation();PLAYER_IS_ALIVE=true;saveGame();}
function saveGame()
{localStorage.setItem('pixeldefenders-game-version',VERSION);localStorage.setItem('pixeldefenders',JSON.stringify(player));$('.game-saved').fadeIn(250).delay(500).fadeOut(250);}
function initializeGame()
{resetGame(false);}
function resetGame(confirmation)
{if(!confirmation||confirm('Do you wish to reset the game?'))
{IS_PLAYING=false;BOSS_LEVEL=false;current_level_kills=0;(game.scene.getScene('GameBattle')).removeAllEnemies();clearInterval(gameloop);target=null;player=empty_player_structure;player.heroes_list.push(new Hero('hero-1'));saveGame();$('.header').delay(250).fadeIn(1500);$('.welcome-button').delay(500).fadeIn(1500);}
if(confirmation)
window.location.reload(true);}
function Hero(id){this.id=id;this.slot_position=0;this.equipment_slots=[];for(var i=0;i<ship_stats[id].upgrade_slots.length;i++)
this.equipment_slots.push(null);this.equipment_found={};this.efficiency=0;this.enabled=false;this.bonusDamageReduction=0;this.bonusDamage=0;this.bonusAttackSpeed=0;this.bonusHp=0;this.selfStatsNoGlobalBonus={};this.rounds=0;this.current_hp=0;}
Hero.prototype.fromJson=function(data){var self=this;this.id=data.id;this.slot_position=data.slot_position;this.efficiency=data.efficiency;this.enabled=false;if(data.equipment_slots!=undefined)
this.equipment_slots=data.equipment_slots;if(data.equipment_found!=undefined)
this.equipment_found=data.equipment_found;if(data.slots!=undefined)
{jQuery.each(data.slots,function(index,slot){index=index.split('_');self.equipment_found['equipment_'+index[1]]=slot;});}}
Hero.prototype.getEfficiencyCost=function(){var per_level_increase=2;var per_breakpoint_increase=10;var breakpoint_levels=5;var next_level=this.efficiency+1;var cost=ship_stats[this.id].base_efficiency_cost*(1+(per_level_increase*next_level)+(Math.floor(next_level/breakpoint_levels)*per_breakpoint_increase));cost=Math.floor(cost*(1-(bonuses['efficiency-cost-reduction'])));return cost;}
Hero.prototype.calculateBonuses=function(){debug('Calculating bonus from '+this.id,0);this.bonusDamageReduction=0;this.bonusDamage=0;this.bonusAttackSpeed=0;this.bonusHp=0;var self=this;$(this.equipment_slots).each(function(slot_index,equipment_id){if(equipment_id!=null)
{var slot=self.equipment_found[equipment_id];var multiplier=qualities[slot.quality].multiplier;var equipment=ship_stats[self.id].equipment[equipment_id];switch(equipment.type)
{case'self-damage-reduction':self.bonusDamageReduction+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'global-damage-reduction':global_equipment_bonuses.damage_reduction+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'self-damage':self.bonusDamage+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'global-damage':global_equipment_bonuses.damage_boost+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'self-attack-speed':self.bonusAttackSpeed+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'global-attack-speed':global_equipment_bonuses.attack_speed+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'global-xp-boost':global_equipment_bonuses.xp_boost+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'self-hp':self.bonusHp+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'global-hp':global_equipment_bonuses.hp_boost+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'global-hp-plus-global-attack-speed-minus':global_equipment_bonuses.hp_boost+=(equipment.values[0]*slot.level*multiplier).toFixedNumber(2);global_equipment_bonuses.attack_speed-=(equipment.values[1]*slot.level*multiplier).toFixedNumber(2);break;case'enemy-hp-plus-global-damage-reduction-minus':global_equipment_bonuses.enemy_hp_reduction+=(equipment.values[0]*slot.level*multiplier).toFixedNumber(2);global_equipment_bonuses.damage_reduction-=(equipment.values[1]*slot.level*multiplier).toFixedNumber(2);break;case'self-damage-plus-self-hp-minus':self.bonusDamage+=(equipment.values[0]*slot.level*multiplier).toFixedNumber(2);self.bonusHp-=(equipment.values[1]*slot.level*multiplier).toFixedNumber(2);break;}}});$(ship_stats[this.id].bonuses).each(function(index,bonus){if(bonus.method=='constant')
{switch(bonus.type)
{case'hp-bonus':global_equipment_bonuses.hp_boost+=(bonus.value+(bonus.value*bonus.efficiency_bonus*self.efficiency)).toFixedNumber(2);break;case'player-damage':global_equipment_bonuses.damage_boost+=(bonus.value+(bonus.value*bonus.efficiency_bonus*self.efficiency)).toFixedNumber(2);break;}}});}
Hero.prototype.updateSelfStatsNoGlobalBonus=function(){var self=this;this.selfStatsNoGlobalBonus.bonusDamageReduction=0;this.selfStatsNoGlobalBonus.bonusDamage=0;this.selfStatsNoGlobalBonus.bonusAttackSpeed=0;this.selfStatsNoGlobalBonus.bonusHp=0;this.selfStatsNoGlobalBonus.hp_boost=0;this.selfStatsNoGlobalBonus.damage_boost=0;$(this.equipment_slots).each(function(slot_index,equipment_id){if(equipment_id!=null)
{var slot=self.equipment_found[equipment_id];var multiplier=qualities[slot.quality].multiplier;var equipment=ship_stats[self.id].equipment[equipment_id];switch(equipment.type)
{case'self-damage-reduction':self.selfStatsNoGlobalBonus.bonusDamageReduction+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'global-damage-reduction':self.selfStatsNoGlobalBonus.bonusDamageReduction+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'self-damage':self.selfStatsNoGlobalBonus.bonusDamage+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'global-damage':self.selfStatsNoGlobalBonus.bonusDamage+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'self-attack-speed':self.selfStatsNoGlobalBonus.bonusAttackSpeed+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'global-attack-speed':self.selfStatsNoGlobalBonus.bonusAttackSpeed+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'self-hp':self.selfStatsNoGlobalBonus.bonusHp+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'global-hp':self.selfStatsNoGlobalBonus.bonusHp+=(equipment.value*slot.level*multiplier).toFixedNumber(2);break;case'global-hp-plus-global-attack-speed-minus':self.selfStatsNoGlobalBonus.bonusHp+=(equipment.values[0]*slot.level*multiplier).toFixedNumber(2);self.selfStatsNoGlobalBonus.bonusAttackSpeed-=(equipment.values[1]*slot.level*multiplier).toFixedNumber(2);break;case'enemy-hp-plus-global-damage-reduction-minus':self.selfStatsNoGlobalBonus.bonusDamageReduction-=(equipment.values[1]*slot.level*multiplier).toFixedNumber(2);break;case'self-damage-plus-self-hp-minus':self.selfStatsNoGlobalBonus.bonusDamage+=(equipment.values[0]*slot.level*multiplier).toFixedNumber(2);self.selfStatsNoGlobalBonus.bonusHp-=(equipment.values[1]*slot.level*multiplier).toFixedNumber(2);break;}}});$(ship_stats[this.id].bonuses).each(function(index,bonus){if(bonus.method=='constant')
{switch(bonus.type)
{case'hp-bonus':self.selfStatsNoGlobalBonus.hp_boost+=(bonus.value+(bonus.value*bonus.efficiency_bonus*self.efficiency)).toFixedNumber(2);break;case'player-damage':self.selfStatsNoGlobalBonus.damage_boost+=(bonus.value+(bonus.value*bonus.efficiency_bonus*self.efficiency)).toFixedNumber(2);break;}}});this.selfStatsNoGlobalBonus.damage=ship_stats[this.id].base_attack*(1+(this.efficiency*0.5));this.selfStatsNoGlobalBonus.damage=(this.selfStatsNoGlobalBonus.damage*(1+((this.selfStatsNoGlobalBonus.bonusDamage+this.selfStatsNoGlobalBonus.damage_boost)/100))).toFixedNumber(2);this.selfStatsNoGlobalBonus.attackSpeed=Math.max(300,ship_stats[this.id].base_attack_speed-(ship_stats[this.id].base_attack_speed*(this.selfStatsNoGlobalBonus.bonusAttackSpeed/100))).toFixedNumber(2);this.selfStatsNoGlobalBonus.health=ship_stats[this.id].base_health*(1+(this.efficiency*0.1));this.selfStatsNoGlobalBonus.health=Math.ceil(this.selfStatsNoGlobalBonus.health*(1+((this.selfStatsNoGlobalBonus.bonusHp+this.selfStatsNoGlobalBonus.hp_boost)/100)));this.selfStatsNoGlobalBonus.damageReduction=(this.selfStatsNoGlobalBonus.bonusDamageReduction+self.selfStatsNoGlobalBonus.damage_reduction).toFixedNumber(2);}
Hero.prototype.refillRounds=function(){this.rounds=this.getMaxRounds();}
Hero.prototype.levelUp=function(){var cost=this.getEfficiencyCost();if(cost<=player.available_credits)
{var current_hp=this.getHealth();this.efficiency++;player.available_credits-=cost;this.current_hp=Math.min(this.getHealth(),this.current_hp+this.getHealth()-current_hp);return true;}
return false;}
Hero.prototype.upgradeEquipment=function(equipment_id){if(this.equipment_found[equipment_id]==undefined||this.equipment_found[equipment_id].level<1)
{alert_message('The selected equipment has not been found yet and cannot be equipped',5000,'warning');return false;}
if(this.equipment_found[equipment_id].quality>4)
{alert_message('The selected equipment is already at maximum quality',5000,'warning');return false;}
if(this.equipment_found[equipment_id].level<qualities[this.equipment_found[equipment_id].quality+1].level_required)
{alert_message('You need to improve the equipment to level '+qualities[this.equipment_found[equipment_id].quality+1].level_required+' until you can upgrade it. Level up the equipment by playing missions',5000,'warning');return false;}
var cost=qualities[this.equipment_found[equipment_id].quality+1].cost;if(cost<=player.available_credits)
{this.equipment_found[equipment_id].quality++;player.available_credits-=cost;return true;}
else
alert_message('You do not have enough XP to purchase the upgrade for this equipment',5000,'warning');return false;}
Hero.prototype.createNew=function(){this.current_hp=this.getHealth();};Hero.prototype.getMaxRounds=function(){return ship_stats[this.id].max_rounds*(1+bonuses['bonus-rounds']);};Hero.prototype.getDamage=function(){debug('Calculating damage of '+this.id+' Self bonus: '+this.bonusDamage+' Global equipment bonus: '+global_equipment_bonuses.damage_boost+' From upgrades: '+bonuses['global-damage']);var damage=ship_stats[this.id].base_attack*(1+(this.efficiency*0.5));damage=damage*(1+((this.bonusDamage+global_equipment_bonuses.damage_boost)/100)+bonuses['global-damage']);if(player.current_mission!=null)
damage=damage*stories[player.current_story].missions[player.current_mission].modifiers.hero_dps;return damage.toFixedNumber(2);}
Hero.prototype.getAttackSpeed=function(){debug('Calculating attack speed of '+this.id+' Self bonus: '+this.bonusAttackSpeed+' Global equipment bonus: '+global_equipment_bonuses.attack_speed);return Math.max(300,ship_stats[this.id].base_attack_speed-(ship_stats[this.id].base_attack_speed*((this.bonusAttackSpeed+global_equipment_bonuses.attack_speed)/100))).toFixedNumber(2);}
Hero.prototype.getHealth=function(){debug('Calculating health of '+this.id+' Self bonus: '+this.bonusHp+' Global equipment bonus: '+global_equipment_bonuses.hp_boost+' From upgrades: '+bonuses['global-hp']);var health=ship_stats[this.id].base_health*(1+(this.efficiency*0.1));health=Math.max(1,health*(1+((this.bonusHp+global_equipment_bonuses.hp_boost)/100)+bonuses['global-hp']));if(player.current_mission!=null)
health=health*stories[player.current_story].missions[player.current_mission].modifiers.hero_health;return Math.ceil(health);}
Hero.prototype.getDamageReduction=function(){debug('Calculating damage redution of '+this.id+' Self bonus: '+this.bonusDamageReduction+' Global equipment bonus: '+global_equipment_bonuses.damage_reduction);return(this.bonusDamageReduction+global_equipment_bonuses.damage_reduction).toFixedNumber(2);}
Hero.prototype.resetHP=function(){var self=this;this.current_hp=this.getHealth();}
class PlayerShip extends Phaser.GameObjects.Image
{constructor(scene,player_index)
{var params=ship_stats[player.heroes_list[player_index].id];super(scene,0,0,'hero-'+params.image);this.setDepth(2);this.setOrigin(0);this.setScale(0.5);this.setAlpha(0);this.player_ship_index=player_index;this.player_ship=player.heroes_list[player_index];this.player_ship.resetHP();this.player_ship.rounds=0;this.params=params;var self=this;var slots=stories[player.current_story].missions[player.current_mission].slot_positions;switch(slots[this.player_ship.slot_position])
{case'middle':this.x=getNum(game.canvas.width)/2-100;break;case'l25':this.x=getNum(game.canvas.width)/4-100;break;case'r25':this.x=(getNum(game.canvas.width)/4*3)-100;break;default:this.x=0;}
this.originalX=this.x;this.health_bar=new HealthBar(scene,this.x-25+(this.displayWidth/2),getNum(game.canvas.height)+6);this.startTimers();this.scene.add.existing(this);this.scene.physics.add.existing(this);this.index=scene.addPlayerShip(this);this.body.setSize(this.width,this.height);this.setInteractive();this.on('pointerdown',showShipInformation,this);$('.game-window .ships').append('<div class="ship" data-player_ship_index="'+player_index+'" id="ship-'+player_index+'"></div>');var ship_html='<div class="image"><img src="support/images/heroes/'+this.params.image+'" /></div>';ship_html+='<div class="level-container" onclick="levelUpShipFromBattle('+this.player_ship_index+')"><span class="level">Lv. '+this.player_ship.efficiency+'</span><span class="level-up'+(this.player_ship.getEfficiencyCost()<=player.available_credits?' level-up-available':'')+'">'+value_to_smart_notation(this.player_ship.getEfficiencyCost())+' xp</span></div>';ship_html+='<div class="fire-container" onclick="refillShipRounds('+this.player_ship_index+')"><span class="rounds'+(this.player_ship.rounds==0?' rounds-empty':'')+'">'+(this.player_ship.rounds==0?'FIRE':tthis.player_ship.rounds)+'</span></div>';$('.game-window .ships .ship#ship-'+this.player_ship_index).html(ship_html);}
startTimers()
{var self=this;if(this.params.base_attack>0)
this.timer=this.scene.time.addEvent({delay:this.player_ship.getAttackSpeed()/SPEED_FACTOR,callback:this.fire(),callbackScope:this});var bonus_delay=0;$(this.params.bonuses).each(function(index,bonus){if(bonus.method=='trigger')
{bonus_delay=bonus.interval*(1-bonuses['bonus-trigger-interval']).toFixedNumber(2);self.scene.time.addEvent({delay:bonus_delay*1000,callback:self.triggerBonus(bonus),callbackScope:self});}});var random=new Phaser.Math.RandomDataGenerator();this.x=this.originalX;this.scene.tweens.add({targets:this,x:{value:self.x+80,duration:random.integerInRange(1500,2500),ease:'Quad.easeInOut'},repeat:-1,yoyo:true,onUpdate:function(){self.health_bar.updatePositionX(self.x-25+(self.displayWidth/2));}});this.y=getNum(game.canvas.height)+250;this.alpha=1;this.scene.tweens.add({targets:this,y:{value:getNum(game.canvas.height)-this.displayHeight-80,duration:1000,ease:'Quad.easeInOut'},repeat:0,onComplete:function(){self.health_bar.updatePositionY(getNum(game.canvas.height)-76);NEW_LEVEL_ANIMATION=false;}});}
triggerBonus(bonus)
{var self=this;if(!IS_PLAYING||!self.player_ship.enabled||self.player_ship.current_hp<=0)
return;var bonus_delay=bonus.interval*(1-bonuses['bonus-trigger-interval']).toFixedNumber(2);setTimeout(function(){self.triggerBonus(bonus);},bonus_delay*1000);if(this.scene==undefined)
return;debug('Triggering '+this.player_ship.id+' bonus ',0);debug(bonus,0);switch(bonus.type)
{case'healing':$(this.scene.player_ships).each(function(index,ship){if(ship.player_ship.current_hp>0&&ship.player_ship.current_hp<ship.player_ship.getHealth())
{var increase_value=(bonus.value+(bonus.value*bonus.efficiency_bonus*ship.player_ship.efficiency)).toFixedNumber(2);ship.heal(increase_value);player.milestones.total_hp_healed=(player.milestones.total_hp_healed||0)+increase_value;if(self.player_ship.id=='hero-3')
player.milestones.relief_hp_healed=(player.milestones.relief_hp_healed||0)+increase_value;checkAchievementCompleted();}});break;}}
resetHP()
{var self=this;this.player_ship.resetHP();this.health_bar.updateAmount(100);}
fire()
{debug('Firing from '+this.player_ship.id+' HP:'+this.player_ship.current_hp,0);var self=this;if(!IS_PLAYING||!self.player_ship.enabled||self.player_ship.current_hp<=0)
return;updateLevelUpFromBattle(this.player_ship_index);if(this.params.base_attack>0)
this.timer=this.scene.time.addEvent({delay:this.player_ship.getAttackSpeed()/SPEED_FACTOR,callback:this.fire,callbackScope:this});if(NEW_LEVEL_ANIMATION)
return;var selected_enemy_id=null;var damage_modifier=bonuses['bonus-auto-fire'];if(this.player_ship.rounds>0)
{damage_modifier+=1;this.player_ship.rounds--;if(this.player_ship.rounds==0)
$('.game-window .ships .ship#ship-'+this.player_ship_index+' .fire-container .rounds').addClass('rounds-empty').html('FIRE');else
$('.game-window .ships .ship#ship-'+this.player_ship_index+' .fire-container .rounds').html(this.player_ship.rounds);}
if(damage_modifier==0)
return;for(var bullet=0;bullet<this.params.base_bullets;bullet++)
{if(this.scene.enemies.length>0)
{switch(this.params.attack)
{case'closest':var y=0;$.each(this.scene.enemies,function(idx,enemy){if(enemy!=null&&enemy.y>y)
{y=enemy.y;selected_enemy_id=idx;}});break;case'stronger':var health=0;$.each(this.scene.enemies,function(idx,enemy){if(enemy!=null&&enemy.current_hp>health)
{health=enemy.current_hp;selected_enemy_id=idx;}});break;case'random':selected_enemy_id=Math.floor(Math.random()*this.scene.enemies.length);break;}
if(selected_enemy_id==null||this.scene.enemies[selected_enemy_id]==null)
selected_enemy_id=null;var projectile=this.scene.physics.add.image(0,0,'hero-'+this.params.projectile).setAlpha(1);projectile.scale=0.7;projectile.damage=Math.ceil(this.player_ship.getDamage()*damage_modifier);projectile.x=this.x+this.displayWidth/2+projectile.displayWidth/2;projectile.y=this.y-5;projectile.from='player';projectile.player_ship=this.player_ship.id;projectile.sprite=this.params.projectile_hit;projectile.custom_tint=this.params.tint;projectile.hasHit=false;projectile.level=player.level+'-'+(BOSS_LEVEL?1:0);projectile.explosion=null;projectile.setDepth(1);if(projectile.custom_tint!=null)
projectile.tint=projectile.custom_tint;projectile.index=this.scene.addProjectile(projectile);var fire_delay=this.params.base_delay_bullet*bullet;var random=new Phaser.Math.RandomDataGenerator();if(selected_enemy_id==null)
{var vx=random.integerInRange(0,game.canvas.width)-projectile.x;var vy=-projectile.y;}
else
{var vx=(this.scene.enemies[selected_enemy_id].x+(this.scene.enemies[selected_enemy_id].displayWidth/2))-projectile.x;var vy=0;if(this.scene.enemies[selected_enemy_id].y>this.scene.enemies[selected_enemy_id].canvasHeight/4*3)
vy=this.scene.enemies[selected_enemy_id].y-projectile.y;else
vy=random.integerInRange(this.scene.enemies[selected_enemy_id].y,this.scene.enemies[selected_enemy_id].y+this.scene.enemies[selected_enemy_id].displayHeight*2)-projectile.y;}
var dist=Math.sqrt(vx*vx+vy*vy);vx/=dist;vy/=dist;var target_x=projectile.x+vx*game.canvas.height;var target_y=projectile.y+vy*game.canvas.height;var duration=1000*PLAYER_PROJECTILE_FACTOR;this.scene.tweens.add({targets:projectile,delay:fire_delay,repeat:0});if(this.params.projectile_rotate)
{this.scene.tweens.add({targets:projectile,rotation:{value:3.14,duration:300,ease:'linear'},repeat:-1});}
else
{var dx=projectile.x-target_x;var dy=projectile.y-target_y;projectile.rotation=Math.atan2(-dy,-dx)+(Math.PI/2);}
this.scene.tweens.add({targets:self.scene.projectiles[projectile.index],x:{value:target_x,duration:duration,ease:'linear'},y:{value:target_y,duration:duration,ease:'linear'},delay:fire_delay,repeat:0,onStart:function(){if(player.options.sound)
audio[self.params.projectile_audio].play();},onComplete:function(tween,targets){if(targets[0].level==(player.level+'-'+(BOSS_LEVEL?1:0)))
{if(!game.scene.getScene('GameBattle').removeProjectile(targets[0].index))
{debug('==== Player projectile NOT REMOVED '+(targets[0]==null)+' '+targets[0].index,3);targets[0].destroy();}}
else
{debug('==== Player projectile from previous level removed '+(targets[0]==null)+' '+targets[0].index,3);targets[0].destroy();}}});}}}
heal(hp)
{var self=this;debug(this.player_ship.id+' received '+hp+' hp',0);this.player_ship.current_hp=Math.min(this.player_ship.current_hp+hp,this.player_ship.getHealth());this.health_bar.updateAmount(this.player_ship.current_hp/this.player_ship.getHealth()*100);}
hit(damage)
{if(!PLAYER_IS_ALIVE)
return;var damage_reduction=this.player_ship.getDamageReduction();var damage_taken=Math.max(0,damage-damage_reduction);debug(this.player_ship.id+' took '+damage_taken+' damage',0);this.player_ship.current_hp-=Math.max(0,damage_taken);this.health_bar.updateAmount(this.player_ship.current_hp/this.player_ship.getHealth()*100);player.milestones.hits_on_player_ship=(player.milestones.hits_on_player_ship||0)+1;player.milestones.total_damage_received=(player.milestones.total_damage_received||0)+damage_taken;player.milestones.total_damage_prevented=(player.milestones.total_damage_prevented||0)+damage_reduction;switch(this.player_ship.id)
{case'hero-1':player.milestones.stargazer_damage_received=(player.milestones.stargazer_damage_received||0)+damage_taken;player.milestones.stargazer_hits_on_player_ship=(player.milestones.stargazer_hits_on_player_ship||0)+1;break;case'hero-2':player.milestones.bruiser_damage_received=(player.milestones.bruiser_damage_received||0)+damage_taken;player.milestones.bruiser_hits_on_player_ship=(player.milestones.bruiser_hits_on_player_ship||0)+1;break;case'hero-3':player.milestones.relief_damage_received=(player.milestones.relief_damage_received||0)+damage_taken;player.milestones.relief_hits_on_player_ship=(player.milestones.relief_hits_on_player_ship||0)+1;break;}
checkAchievementCompleted();if(this.player_ship.current_hp<=0)
this.setAlpha(0.5);var all_dead=true;$(this.scene.player_ships).each(function(index,ship){if(ship.player_ship.current_hp>0)
{all_dead=false;return false;}});if(all_dead)
{PLAYER_IS_ALIVE=false;hideMissionLevelReached();$('.ships-disabled').center().fadeIn(500);if(!player.repeating_level)
send_push_notification('Ships disabled','All your ships have been disabled!');restartTimer=setTimeout(function(){restartLevel();},10000);$('.mission-information-box .progress-bar .inner-bar').stop().css({width:0}).animate({width:'100%'},10000,'linear');}}}
function manageShips(selected_ship_id)
{tutorial_message('menu-ship');$('#main-content').load('./ships.html',function(){$.each(ship_stats,function(ship_id,ship){var player_ship_index=null;$.each(player.heroes_list,function(ship_index,player_ship){if(player_ship.id==ship_id)
{player_ship_index=ship_index;player_ship.updateSelfStatsNoGlobalBonus();}});var ship_level_up_cost=player_ship_index!=null?player.heroes_list[player_ship_index].getEfficiencyCost():-1;var html='<div id="ship-selector-'+ship_id+'" onclick="showShipConfiguration(\''+ship_id+'\');" class="ship'+(player_ship_index==null?' ship-locked':'')+'"><div class="image"><span class="available-upgrades"'+(ship_level_up_cost!=-1&&ship_level_up_cost<=player.available_credits?' style="display:block;"':'')+'>*</span><img src="support/images/heroes/'+ship.image+'" /></div></div>';$('.ship-selection').append(html);html='<div class="ship" id="ship-details-'+ship_id+'"><span class="name">'+ship.name+(player_ship_index==null?'<span class="locked">locked</span>':'<span class="level">'+player.heroes_list[player_ship_index].efficiency+'</span>')+'</span>';html+='<div class="statistics ship-attack"><span class="statistic">Attack <span class="value">'+(player_ship_index==null?ship.base_attack:player.heroes_list[player_ship_index].selfStatsNoGlobalBonus.damage)+'</span></span>';html+='<span class="statistic ship-health">Health <span class="value">'+(player_ship_index==null?ship.base_health:player.heroes_list[player_ship_index].selfStatsNoGlobalBonus.health)+'</span></span>';if(ship.base_attack>0)
{html+='<span class="statistic ship-attack-speed">Attack speed <span class="value">'+(player_ship_index==null?(ship.base_attack_speed/1000).toFixedNumber(2):(player.heroes_list[player_ship_index].selfStatsNoGlobalBonus.attackSpeed/1000).toFixedNumber(2))+'</span></span>';html+='<span class="statistic ship-dps">DPS <span class="value">'+(player_ship_index==null?(ship.base_attack/(ship.base_attack_speed/1000)).toFixedNumber(2):(player.heroes_list[player_ship_index].selfStatsNoGlobalBonus.damage/(player.heroes_list[player_ship_index].selfStatsNoGlobalBonus.attackSpeed/1000)).toFixedNumber(2))+'</span></span>';html+='<span class="statistic">Attack mode <span>'+ship.attack+'</span></span>';}
html+='<span class="statistic">Enemy focus <span>'+ship.enemy_focus+'</span></span>';html+='<span class="statistic">Manual rounds <span>'+(player_ship_index==null?ship.max_rounds:player.heroes_list[player_ship_index].getMaxRounds())+'</span></span>';html+='</div>';var global_bonus_html='';$(ship.bonuses).each(function(index,bonus){switch(bonus.type)
{case'hp-bonus':global_bonus_html='<span class="bonus">Increase all ships health by <span>'+(player_ship_index!=null?(bonus.value+(bonus.value*bonus.efficiency_bonus*player.heroes_list[player_ship_index].efficiency)).toFixedNumber(2):bonus.value)+'%</span></span>';break;case'healing':global_bonus_html='<span class="bonus">Heals all ships <span>'+(player_ship_index!=null?(bonus.value+(bonus.value*bonus.efficiency_bonus*player.heroes_list[player_ship_index].efficiency)).toFixedNumber(2):bonus.value)+'hp every '+(bonus.interval*(1-bonuses['bonus-trigger-interval']).toFixedNumber(2))+' seconds</span></span>';break;case'player-damage':global_bonus_html='<span class="bonus">Increase all ships damage by <span>'+(player_ship_index!=null?(bonus.value+(bonus.value*bonus.efficiency_bonus*player.heroes_list[player_ship_index].efficiency)).toFixedNumber(2):bonus.value)+'%</span></span>';break;}});if(global_bonus_html!='')
html+='<div class="bonuses"><h2>Bonuses</h2>'+global_bonus_html+'</div>';if(player_ship_index!=null)
{html+='<span class="level-up-button button-glow" onclick="levelUpShip(\''+player_ship_index+'\', \''+ship_id+'\');">Level up<span>'+value_to_smart_notation(ship_level_up_cost)+' xp</span></span>';if(Object.keys(player.heroes_list[player_ship_index].equipment_found).length>0)
{html+='<div class="buy-equipments"><h2>Buy equipment box</h2>';html+='<div class="button-container"><span class="buy-button button-glow" onclick="buyEquipmentBox(\''+player_ship_index+'\', \''+ship_id+'\', 0);">Basic<br />5 equipments<br />25000 XP</span></div>';html+='<div class="button-container"><span class="buy-button button-glow" onclick="buyEquipmentBox(\''+player_ship_index+'\', \''+ship_id+'\', 1);">Intermediate<br />10 equipments<br />50000 XP</span></div>';html+='<div class="button-container"><span class="buy-button button-glow" onclick="buyEquipmentBox(\''+player_ship_index+'\', \''+ship_id+'\', 2);">Pro<br />20 equipments<br />100000 XP</span></div>';html+='</div>';}
html+='<div class="equipments"><h2>Equipment</h2>';html+='<div class="slots active-slots">Active slots ';$(player.heroes_list[player_ship_index].equipment_slots).each(function(slot_index,equipment_id){html+='<span class="slot'+(ship.upgrade_slots[slot_index]>player.heroes_list[player_ship_index].efficiency?' slot-locked':'')+'"'+(ship.upgrade_slots[slot_index]>player.heroes_list[player_ship_index].efficiency?' title="Slot unlocks at level '+ship.upgrade_slots[slot_index]+'"':'')+(equipment_id!=null?'title="'+getEquipmentTypeDescription(ship.equipment[equipment_id],player.heroes_list[player_ship_index].equipment_found[equipment_id])+'"':'')+'>'+(ship.upgrade_slots[slot_index]>player.heroes_list[player_ship_index].efficiency?ship.upgrade_slots[slot_index]:(equipment_id!=null?bonus_icon_image(ship.equipment[equipment_id].type):'-'))+'</span>';});html+='</div>';html+='<div id="equipment-list-'+ship_id+'"></div>';html+='</div>';}
html+='</div>';$('.ship-details').append(html);if(player_ship_index!=null)
loadShipEquipmentList(player_ship_index,ship_id);});$('.ship-selection .ship:eq('+(selected_ship_id!=undefined?selected_ship_id:0)+')').addClass('ship-selected');$('.ship-details .ship:eq('+(selected_ship_id!=undefined?selected_ship_id:0)+')').show(0);});}
function loadShipEquipmentList(player_ship_index,ship_id)
{var html='';$.each(ship_stats[ship_id].equipment,function(equipment_id,equipment_piece){var player_equipment=player.heroes_list[player_ship_index].equipment_found[equipment_id];html+='<div class="equipment">';html+='<div class="name">'+getEquipmentName(equipment_piece.type)+'<span class="image">'+bonus_icon_image(equipment_piece.type)+'</span></div>';html+='<div class="info">';html+='<span class="current-level"><span class="progress" style="width: '+(player_equipment!=undefined&&player_equipment.quality<4?(player_equipment.level/qualities[player_equipment.quality+1].level_required*100):100)+'%;"></span><span class="text">Level: '+(player_equipment!=undefined?player_equipment.level:0)+(player_equipment!=undefined&&player_equipment.quality==4&&equipment_piece.max_level!=0?'/'+equipment_piece.max_level:'')+'</span></span>';html+='<span class="quality" id="quality-'+player_ship_index+'-'+equipment_id+'" style="background-color: '+(player_equipment!=undefined?qualities[player_equipment.quality].color:qualities[0].color)+'">'+(player_equipment!=undefined?qualities[player_equipment.quality].name:qualities[0].name)+'</span>';if(player_equipment!=undefined&&player_equipment.level>0)
{html+='<div class="slots install-slot">Install on slot ';$(player.heroes_list[player_ship_index].equipment_slots).each(function(slot_index,installed_equipment_id){if(ship_stats[ship_id].upgrade_slots[slot_index]<=player.heroes_list[player_ship_index].efficiency)
html+='<span id="install-slot-'+player_ship_index+'-'+equipment_id+'-'+slot_index+'" onclick="installEquipment('+player_ship_index+', \''+ship_id+'\', '+slot_index+', \''+equipment_id+'\');" class="slot-'+ship_id+'-'+slot_index+' slot'+(installed_equipment_id==equipment_id?' slot-installed':'')+'">'+(slot_index+1)+'</span>';else
html+='<span id="install-slot-'+player_ship_index+'-'+equipment_id+'-'+slot_index+'" onclick="installEquipment('+player_ship_index+', \''+ship_id+'\', '+slot_index+', \''+equipment_id+'\');" class="slot-'+ship_id+'-'+slot_index+' slot slot-hidden">'+(slot_index+1)+'</span>';});html+='</div>';}
html+='<span class="description" id="description-'+player_ship_index+'-'+equipment_id+'" >'+getEquipmentTypeDescription(equipment_piece,player_equipment!=undefined?player_equipment:{quality:0,level:0})+'</span>';if(player_equipment!=undefined)
{if(player_equipment.quality<4)
{var next_level_upgrade=player_equipment!=undefined?qualities[player_equipment.quality+1].level_required:qualities[1].level_required;if(player_equipment!=undefined&&player_equipment.level>=next_level_upgrade)
{html+='<span id="upgrade-button-'+player_ship_index+'-'+equipment_id+'" class="upgrade-equipment-button button-glow" onclick="upgradeEquipment('+player_ship_index+', \''+ship_id+'\', \''+equipment_id+'\');">';html+='Upgrade to '+(player_equipment!=undefined?qualities[player_equipment.quality+1].name:qualities[1].name)+' from level '+next_level_upgrade;html+='<span>'+value_to_smart_notation(player_equipment!=undefined?qualities[player_equipment.quality+1].cost:qualities[1].cost)+' xp</span>';html+='</span>';}
else
html+='<span class="upgrade-equipment-text">Equipment must be at least level '+next_level_upgrade+' before you can upgrade the quality.</span>';}
else
html+='<span class="upgrade-equipment-text">Equipment at maximum level</span>';}
else
html+='<span class="upgrade-equipment-text">Equipment not found. Play more missions to unlock it.</span>';html+='</div>';html+='</div>';});$('#equipment-list-'+ship_id).html(html);}
function buyEquipmentBox(player_ship_id,ship_id,box_id)
{var costs=[25000,50000,100000];var quantities=[5,10,20];if(costs[box_id]>player.available_credits)
{alert_message('You do not have enough XP to purchase this equipment box',5000,'warning');return false;}
if(Object.keys(player.heroes_list[player_ship_id].equipment_found).length==0)
{alert_message('You do not have any equipment found for this ship',5000,'warning');return false;}
player.available_credits=player.available_credits-costs[box_id];$('#stat-xp span').html(value_to_smart_notation(player.available_credits)).show(0);var equipment;var equipments_generated={};for(var i=0;i<quantities[box_id];i++)
{equipment=generateEquipment(player_ship_id,false,false);if(equipments_generated[equipment.equipment_id]==undefined)
equipments_generated[equipment.equipment_id]=1;else
equipments_generated[equipment.equipment_id]++;}
var text='';$.each(equipments_generated,function(equipment_id,quantity){text+=getEquipmentName(ship_stats[player.heroes_list[player_ship_id].id].equipment[equipment_id].type)+' - '+quantity+' levels<br />';});loadShipEquipmentList(player_ship_id,ship_id);info_message_box('New equipment added',text);}
function showShipConfiguration(ship_index)
{$('.ship-selection .ship').removeClass('ship-selected');$('.ship-details .ship').hide(0);$('.ship-selection .ship#ship-selector-'+ship_index).addClass('ship-selected');$('.ship-details .ship#ship-details-'+ship_index).show(0);}
function levelUpShipFromBattle(player_ship_id)
{if(player.heroes_list[player_ship_id].levelUp())
{updateLevelUpFromBattle(player_ship_id);$(player.heroes_list[player_ship_id].equipment_slots).each(function(slot_index,equipment_id){if(ship_stats[player.heroes_list[player_ship_id].id].upgrade_slots[slot_index]==player.heroes_list[player_ship_id].efficiency)
{alert_message('You have unlocked a new equipment slot for the ship <span class="purple uc">'+ship_stats[player.heroes_list[player_ship_id].id].name+'</span>',5000,'information');return;}});}
else
alert_message('You do not have enough XP to purchase an upgrade for this ship',5000,'warning');}
function updateLevelUpFromBattle(player_ship_id)
{$('.game-window .ships .ship#ship-'+player_ship_id+' .level-container .level').html('Lv. '+player.heroes_list[player_ship_id].efficiency);$('.game-window .ships .ship#ship-'+player_ship_id+' .level-container .level-up').removeClass('level-up-available');if(player.heroes_list[player_ship_id].getEfficiencyCost()<=player.available_credits)
$('.game-window .ships .ship#ship-'+player_ship_id+' .level-container .level-up').addClass('level-up-available');$('.game-window .ships .ship#ship-'+player_ship_id+' .level-container .level-up').html(value_to_smart_notation(player.heroes_list[player_ship_id].getEfficiencyCost())+' xp');}
function levelUpShip(player_ship_id,ship_id)
{playSelectMenu();if(player.heroes_list[player_ship_id].levelUp())
{var ship_level_up_cost=player.heroes_list[player_ship_id].getEfficiencyCost();$('#stat-xp span').html(value_to_smart_notation(player.available_credits)).show(0);$('#ship-details-'+ship_id+' .level').html(player.heroes_list[player_ship_id].efficiency);$('#ship-details-'+ship_id+' .level-up-button span').html(value_to_smart_notation(ship_level_up_cost)+' xp');updateShipStatisticsInformation(player_ship_id,ship_id);var global_bonus_html='';$(ship_stats[player.heroes_list[player_ship_id].id].bonuses).each(function(index,bonus){switch(bonus.type)
{case'hp-bonus':global_bonus_html='<span class="bonus">Increase all ships health by <span>'+(bonus.value+(bonus.value*bonus.efficiency_bonus*player.heroes_list[player_ship_id].efficiency)).toFixedNumber(2)+'%</span></span>';break;case'healing':global_bonus_html='<span class="bonus">Heals all ships <span>'+(bonus.value+(bonus.value*bonus.efficiency_bonus*player.heroes_list[player_ship_id].efficiency)).toFixedNumber(2)+'hp every '+(bonus.interval*(1-bonuses['bonus-trigger-interval']).toFixedNumber(2))+' seconds</span></span>';break;case'player-damage':global_bonus_html='<span class="bonus">Increase all ships damage by <span>'+(bonus.value+(bonus.value*bonus.efficiency_bonus*player.heroes_list[player_ship_id].efficiency)).toFixedNumber(2)+'%</span></span>';break;}});if(global_bonus_html!='')
{global_bonus_html='<h2>Bonuses</h2>'+global_bonus_html;$('#ship-details-'+ship_id+' .bonuses').html(global_bonus_html);}
html='Active slots ';$(player.heroes_list[player_ship_id].equipment_slots).each(function(slot_index,equipment_id){html+='<span class="slot'+(ship_stats[player.heroes_list[player_ship_id].id].upgrade_slots[slot_index]>player.heroes_list[player_ship_id].efficiency?' slot-locked':'')+'"'+(ship_stats[player.heroes_list[player_ship_id].id].upgrade_slots[slot_index]>player.heroes_list[player_ship_id].efficiency?' title="Slot unlocks at level '+ship_stats[player.heroes_list[player_ship_id].id].upgrade_slots[slot_index]+'"':'')+'>'+(ship_stats[player.heroes_list[player_ship_id].id].upgrade_slots[slot_index]>player.heroes_list[player_ship_id].efficiency?ship_stats[player.heroes_list[player_ship_id].id].upgrade_slots[slot_index]:(equipment_id!=null?bonus_icon_image(ship_stats[player.heroes_list[player_ship_id].id].equipment[equipment_id].type):'-'))+'</span>';if(ship_stats[player.heroes_list[player_ship_id].id].upgrade_slots[slot_index]<=player.heroes_list[player_ship_id].efficiency)
$('.slot-'+ship_id+'-'+slot_index).removeClass('slot-hidden');});$('#ship-details-'+ship_id+' .active-slots').html(html);calculateUpgradeNotification();}
else
alert_message('You do not have enough XP to purchase an upgrade for this ship',5000,'warning');}
function updateShipStatisticsInformation(player_ship_id,ship_id)
{player.heroes_list[player_ship_id].updateSelfStatsNoGlobalBonus();var html='<span class="statistic">Attack <span>'+player.heroes_list[player_ship_id].selfStatsNoGlobalBonus.damage+'</span></span>';html+='<span class="statistic">Health <span>'+player.heroes_list[player_ship_id].selfStatsNoGlobalBonus.health+'</span></span>';if(ship_stats[player.heroes_list[player_ship_id].id].base_attack>0)
{html+='<span class="statistic">Attack speed <span>'+(player.heroes_list[player_ship_id].selfStatsNoGlobalBonus.attackSpeed/1000).toFixedNumber(2)+'</span></span>';html+='<span class="statistic">DPS <span>'+(player.heroes_list[player_ship_id].selfStatsNoGlobalBonus.damage/(player.heroes_list[player_ship_id].selfStatsNoGlobalBonus.attackSpeed/1000)).toFixedNumber(2)+'</span></span>';html+='<span class="statistic">Attack mode <span>'+ship_stats[player.heroes_list[player_ship_id].id].attack+'</span></span>';}
html+='<span class="statistic">Enemy focus <span>'+ship_stats[player.heroes_list[player_ship_id].id].enemy_focus+'</span></span>';$('#ship-details-'+ship_id+' .statistics').html(html);}
function installEquipment(player_ship_id,ship_id,slot_index,equipment_id)
{playSelectMenu();if(ship_stats[ship_id].upgrade_slots[slot_index]>player.heroes_list[player_ship_id].efficiency)
{alert_message('The selected slot is currently locked. Level up your ship to unlock more upgrade slots',5000,'warning');return;}
if(player.heroes_list[player_ship_id].equipment_found[equipment_id]==undefined||player.heroes_list[player_ship_id].equipment_found[equipment_id].level<1)
{alert_message('The selected equipment has not been found yet and cannot be equipped',5000,'warning');return;}
var is_equipped=false;$(player.heroes_list[player_ship_id].equipment_slots).each(function(installed_slot_index,installed_equipment_id){if(installed_equipment_id==equipment_id)
{is_equipped=true;return;}});if(!is_equipped)
{player.heroes_list[player_ship_id].equipment_slots[slot_index]=equipment_id;if($('.ship-information #hp-attack').length>0)
updateBonuses();$('.slot-'+ship_id+'-'+slot_index).removeClass('slot-installed');$('#install-slot-'+player_ship_id+'-'+equipment_id+'-'+slot_index).addClass('slot-installed');$('#ship-details-'+ship_id+' .active-slots .slot:eq('+slot_index+')').html(bonus_icon_image(ship_stats[ship_id].equipment[equipment_id].type));$('#ship-details-'+ship_id+' .active-slots .slot:eq('+slot_index+')').attr('title',getEquipmentTypeDescription(ship_stats[ship_id].equipment[equipment_id],player.heroes_list[player_ship_id].equipment_found[equipment_id]));$('.ship-information .active-slots .slot:eq('+slot_index+')').html(bonus_icon_image(ship_stats[ship_id].equipment[equipment_id].type));$('.ship-information .active-slots .slot:eq('+slot_index+')').attr('title',getEquipmentTypeDescription(ship_stats[ship_id].equipment[equipment_id],player.heroes_list[player_ship_id].equipment_found[equipment_id]));if($('.ship-information #hp-attack').length>0)
{$('.ship-information #hp-attack').html(player.heroes_list[player_ship_id].getDamage());$('.ship-information #hp-hp').html(player.heroes_list[player_ship_id].getHealth()+' ('+player.heroes_list[player_ship_id].current_hp.toFixedNumber(2)+')');$('.ship-information #hp-dr').html(player.heroes_list[player_ship_id].getDamageReduction()+'hp');$('.ship-information #hp-as').html((player.heroes_list[player_ship_id].getAttackSpeed()/1000).toFixedNumber(2)+' sec');$('.ship-information #hp-dps').html((player.heroes_list[player_ship_id].getDamage()/(player.heroes_list[player_ship_id].getAttackSpeed()/1000)).toFixedNumber(2));}
if($('#ship-details-'+ship_id+' .ship-attack').length>0)
updateShipStatisticsInformation(player_ship_id,ship_id);}}
function upgradeEquipment(player_ship_id,ship_id,equipment_id)
{playSelectMenu();if(player.heroes_list[player_ship_id].upgradeEquipment(equipment_id))
{updateShipStatisticsInformation(player_ship_id,ship_id);$('#stat-xp span').html(value_to_smart_notation(player.available_credits)).show(0);$('#quality-'+player_ship_id+'-'+equipment_id).css({'background-color':qualities[player.heroes_list[player_ship_id].equipment_found[equipment_id].quality].color}).html(qualities[player.heroes_list[player_ship_id].equipment_found[equipment_id].quality].name);$('#description-'+player_ship_id+'-'+equipment_id).html(getEquipmentTypeDescription(ship_stats[ship_id].equipment[equipment_id],player.heroes_list[player_ship_id].equipment_found[equipment_id]));if(player.heroes_list[player_ship_id].equipment_found[equipment_id].quality==4)
$('#upgrade-button-'+player_ship_id+'-'+equipment_id).remove();else
{var html='Upgrade to '+qualities[player.heroes_list[player_ship_id].equipment_found[equipment_id].quality+1].name+' from level '+qualities[player.heroes_list[player_ship_id].equipment_found[equipment_id].quality+1].level_required;html+='<span>'+value_to_smart_notation(qualities[player.heroes_list[player_ship_id].equipment_found[equipment_id].quality+1].cost)+' xp</span>';$('#upgrade-button-'+player_ship_id+'-'+equipment_id).html(html);}
calculateUpgradeNotification();}}
function showShipInformation()
{var player_ship=this.player_ship;var self=this;if(!$('.ship-information').is(':visible'))
$('.ship-information').fadeIn(300);$('.ship-information #hp-name').html(ship_stats[player_ship.id].name+'<span class="level">'+player_ship.efficiency+'</span>');$('.ship-information #hp-attack').html(player_ship.getDamage());$('.ship-information #hp-hp').html(player_ship.getHealth()+' ('+player_ship.current_hp.toFixedNumber(2)+')');$('.ship-information #hp-dr').html(player_ship.getDamageReduction()+'hp');$('.ship-information #hp-as').html((player_ship.getAttackSpeed()/1000).toFixedNumber(2)+' sec');$('.ship-information #hp-dps').html((player_ship.getDamage()/(player_ship.getAttackSpeed()/1000)).toFixedNumber(2));$('.ship-information #hp-am').html(ship_stats[player_ship.id].attack);$('.ship-information #hp-ef').html(ship_stats[player_ship.id].enemy_focus);$('.ship-information #hp-mr').html(player_ship.getMaxRounds());var global_bonus_html='';$(ship_stats[player_ship.id].bonuses).each(function(index,bonus){switch(bonus.type)
{case'hp-bonus':global_bonus_html='<span class="bonus">Increase all ships health by <span>'+(bonus.value+(bonus.value*bonus.efficiency_bonus*player_ship.efficiency)).toFixedNumber(2)+'%</span></span>';break;case'healing':global_bonus_html='<span class="bonus">Heals all ships <span>'+(bonus.value+(bonus.value*bonus.efficiency_bonus*player_ship.efficiency)).toFixedNumber(2)+'hp every '+(bonus.interval*(1-bonuses['bonus-trigger-interval']).toFixedNumber(2))+' seconds</span></span>';break;case'player-damage':global_bonus_html='<span class="bonus">Increase all ships damage by <span>'+(bonus.value+(bonus.value*bonus.efficiency_bonus*player_ship.efficiency)).toFixedNumber(2)+'%</span></span>';break;}});if(global_bonus_html!='')
$('.ship-information .bonuses').html('<h2>Bonuses</h2>'+global_bonus_html);var html='Active slots ';$(player_ship.equipment_slots).each(function(slot_index,equipment_id){if(ship_stats[player_ship.id].upgrade_slots[slot_index]<=player_ship.efficiency)
html+='<span class="slot"'+(equipment_id!=null?'title="'+getEquipmentTypeDescription(ship_stats[player_ship.id].equipment[equipment_id],player_ship.equipment_found[equipment_id])+'"':'')+'>'+(equipment_id!=null?bonus_icon_image(ship_stats[player_ship.id].equipment[equipment_id].type):'-')+'</span>';});html+='</div>';$('.active-slots').html(html);$('.equipment-list').html('');$.each(ship_stats[player_ship.id].equipment,function(equipment_id,equipment_piece){var player_equipment=player_ship.equipment_found[equipment_id];if(player_equipment!=undefined&&player_equipment.level>0)
{var multiplier=qualities[player_equipment.quality].multiplier;html='<div class="equipment">';html+='<div class="name">'+getEquipmentName(equipment_piece.type)+'<span class="image">'+bonus_icon_image(equipment_piece.type)+'</span></div>';html+='<div class="info">';html+='<span class="current-level"><span class="progress" style="width: '+(player_equipment.quality<4?player_equipment.level/qualities[player_equipment.quality+1].level_required*100:100)+'%;"></span><span class="text">Level: '+player_equipment.level+(player_equipment.quality==4&&equipment_piece.max_level!=0?'/'+equipment_piece.max_level:'')+'</span></span>';html+='<span class="quality" style="background-color: '+qualities[player_equipment.quality].color+'">'+qualities[player_equipment.quality].name+'</span>';html+='<div class="slots install-slot">Install on slot ';$(player_ship.equipment_slots).each(function(slot_index,installed_equipment_id){if(ship_stats[player_ship.id].upgrade_slots[slot_index]<=player_ship.efficiency)
html+='<span id="install-slot-'+self.player_ship_index+'-'+equipment_id+'-'+slot_index+'" onclick="installEquipment('+self.player_ship_index+', \''+player_ship.id+'\', '+slot_index+', \''+equipment_id+'\');" class="slot-'+player_ship.id+'-'+slot_index+' slot'+(installed_equipment_id==equipment_id?' slot-installed':'')+'">'+(slot_index+1)+'</span>';});html+='</div>';html+='<span class="description">'+getEquipmentTypeDescription(equipment_piece,player_equipment)+'</span>';$('.equipment-list').append(html);}});}
function calculateUpgradeNotification()
{$.each(player.heroes_list,function(ship_index,player_ship){if(player_ship.getEfficiencyCost()<=player.available_credits)
$('#ship-selector-'+player_ship.id+' .available-upgrades').show(0);else
$('#ship-selector-'+player_ship.id+' .available-upgrades').hide(0);});}
function manageUpgrades()
{tutorial_message('upgrades-welcome');$('#main-content').load('./upgrades.html',function(){$.each(upgrades,function(upgrade_id,upgrade){var html='<div class="upgrade button-glow" onclick="buyUpgrade(\''+upgrade_id+'\')"><span class="name">'+upgrade.name+'</span>';html+='<span class="image">'+bonus_icon_image(upgrade.type)+'</span>';html+='<span class="description">'+getUpgradeDescription(upgrade_id)+'</span>';html+='<div class="info"><span class="current-level">Level: '+getNum(player.upgrades[upgrade_id])+'/'+upgrade.max_level+'</span>';html+='<span class="current-bonus">Bonus: '+(upgradeBonus(upgrade_id,upgrade.modifier)*100).toFixedNumber(0)+'%</span>';if(getNum(player.upgrades[upgrade_id])<upgrade.max_level)
html+='<span class="next-cost">Upgrade: '+upgradeCost(upgrade_id)+'</span></div>';else
html+='<span class="next-cost">Max level</span></div>';if(upgrade.requirements.length>0)
{requirements_html='';$(upgrade.requirements).each(function(index,requirement_id){if(getNum(player.upgrades[requirement_id])==0)
requirements_html+='<span class="'+(getNum(player.upgrades[requirement_id])>0?'requirement-unlocked':'requirement-not-unlocked')+'">'+upgrades[requirement_id].name+'</span>';});if(requirements_html!='')
html+='<span class="requirements"><h2>Requirements</h2>'+requirements_html+'</span>';}
html+='</div>';$('.available-upgrades').append(html);if(upgrade.type=='equipment-drop-rate')
$('.bonuses-container #bonuses-'+upgrade.type).html((BASE_DROP_RATE_PROBABILITY+bonuses[upgrade.type]*100).toFixedNumber(0)+'%');else
$('.bonuses-container #bonuses-'+upgrade.type).html((bonuses[upgrade.type]*100).toFixedNumber(0)+'%');$('.bonuses-container #bonuses-image-'+upgrade.type).html(bonus_icon_image(upgrade.type));});});}
function getUpgradeDescription(upgrade_id)
{switch(upgrades[upgrade_id].type)
{case'global-damage':return'Increase the damage of all ships';case'efficiency-cost-reduction':return'Reduce the cost to level up ships';case'global-xp-boost':return'Increase the XP received';case'enemy-hp-reduction':return"Reduce enemies HP";case'global-hp':return'Increase the HP of all ships';case'equipment-drop-rate':return'Increase the probability of getting an equipment piece after fighting a boss';case'bonus-trigger-interval':return'Reduce the trigger interval of ship bonuses';case'bonus-auto-fire':return'Activates and increases the damage dealt by auto fire';case'bonus-rounds':return'Increase the number of manual fire rounds a ship has available';}}
function upgradeBonus(upgrade_id,base_modifier)
{return base_modifier*getNum(player.upgrades[upgrade_id]);}
function upgradeCost(upgrade_id)
{return upgrades[upgrade_id].cost_modifier*(getNum(player.upgrades[upgrade_id])+1);}
function buyUpgrade(upgrade_id)
{playSelectMenu();var hasRequirements=true;if(upgrades[upgrade_id].requirements.length>0)
{$(upgrades[upgrade_id].requirements).each(function(index,requirement_id){if(!getNum(player.upgrades[requirement_id])>0)
{hasRequirements=false;return false;}});if(!hasRequirements)
{alert_message('You must unlock all the requirements before purchasing this upgrade',5000,'warning');return false;}}
if(player.upgrades[upgrade_id]==undefined||player.upgrades[upgrade_id]<upgrades[upgrade_id].max_level)
{var cost=upgradeCost(upgrade_id);if(cost<=player.available_points)
{if(player.upgrades[upgrade_id]==undefined)
player.upgrades[upgrade_id]=1;else
player.upgrades[upgrade_id]++;player.available_points-=cost;$('#stat-points span').html(getNum(player.available_points));manageUpgrades();}
else
alert_message('Not enough points to purchase this upgrade',5000,'warning');}
else
alert_message('Maximum level reached',5000,'warning');}
function updateBonuses()
{debug('Calculating global bonuses');bonuses={};$.each(upgrades,function(id,upgrade){if(bonuses[upgrade.type]==undefined)
bonuses[upgrade.type]=0;bonuses[upgrade.type]+=upgradeBonus(id,upgrade.modifier);});global_equipment_bonuses={xp_boost:0,damage_reduction:0,hp_boost:0,damage_boost:0,attack_speed:0,enemy_hp_reduction:0};$(player.heroes_list).each(function(index,hero){if(hero.enabled)
player.heroes_list[index].calculateBonuses();});}
function resetUpgradePoints()
{if(confirm('Do you wish to reset all choices and be refunded all points?'))
{player.available_points=player.earned_points;player.upgrades={};saveGame();$('#stat-points span').html(getNum(player.available_points));manageUpgrades();info_message_box('Reset upgrades','All upgrades were reset and all points refunded.');}}